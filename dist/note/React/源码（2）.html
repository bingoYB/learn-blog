<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>源码分析（2） | BINGO BLOG</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/learn-blog/dist/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
    <meta name="description" content="BINGO BLOG 学然后知不足 非淡泊无以明志，非宁静无以致远">
    <meta name="keywords" content="博客，前端，代码，个人博客，学习，兴趣，BINGOBLOG">
    
    <link rel="preload" href="/learn-blog/dist/assets/css/0.styles.4b1e8fc9.css" as="style"><link rel="preload" href="/learn-blog/dist/assets/js/app.f2b1e5cd.js" as="script"><link rel="preload" href="/learn-blog/dist/assets/js/2.9615dc11.js" as="script"><link rel="preload" href="/learn-blog/dist/assets/js/5.0866854b.js" as="script"><link rel="prefetch" href="/learn-blog/dist/assets/js/10.a342c2c8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/11.e3874e66.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/12.1a40b1ad.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/13.5ca5150f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/14.d9846aff.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/15.793bd97a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/16.3a5f59bb.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/17.2da1d357.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/18.0e13a599.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/19.f5f8b743.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/20.6960677d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/21.144d90fc.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/22.d944ca7e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/23.52428397.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/24.856765a8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/25.c6df9714.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/26.8f8bd0fd.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/27.54d7b0bb.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/28.b84ce3ac.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/29.55de5732.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/3.395768f7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/30.4045b06f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/31.8d00d40c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/32.6f89db35.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/33.9282d757.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/34.ccc9e208.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/35.04e240e0.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/36.e0f19ebe.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/37.d6bc54a8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/38.6005ad2e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/39.61965404.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/4.5da2aed6.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/40.c693a727.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/41.36030a88.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/42.8e62f3cc.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/43.8cf4416b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/44.a7c2a2f3.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/45.010cdc4c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/46.9962fc21.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/47.598afb9e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/48.f155c25a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/49.dcc6e5ea.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/50.ebf66c1d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/51.9470cb57.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/52.9d2d8699.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/53.13d2a61b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/54.8b6dd252.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/55.1d10756a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/56.6ed80e61.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/57.695ff431.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/58.36845e00.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/59.3ce8e5d7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/6.3b08041c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/60.ff1ee3d2.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/61.3025900f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/62.47b4a262.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/63.c0fb9ae0.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/64.2b582ee6.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/65.c37a5888.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/66.51114b7d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/67.751a3ae7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/68.7c1b330f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/69.72b95aec.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/7.b560779e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/70.0b3b41e3.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/71.a0ac056a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/72.f1d5001e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/73.a0c155c4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/74.abdb74e9.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/75.e1fcdbf6.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/76.507c63f0.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/77.e4e19fab.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/78.c5e6ad4f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/8.b9943fe4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/9.cd2a7470.js">
    <link rel="stylesheet" href="/learn-blog/dist/assets/css/0.styles.4b1e8fc9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-blog/dist/" class="home-link router-link-active"><img src="/learn-blog/dist/logo.png" alt="BINGO BLOG" class="logo"> <span class="site-name can-hide">BINGO BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/learn-blog/dist/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/learn-blog/dist/algorithm/" class="nav-link">
  算法
</a></div> <a href="https://github.com/bingoYB/learn-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/learn-blog/dist/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/learn-blog/dist/algorithm/" class="nav-link">
  算法
</a></div> <a href="https://github.com/bingoYB/learn-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程思想</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-blog/dist/note/React/合成事件.html" class="sidebar-link">合成事件</a></li><li><a href="/learn-blog/dist/note/React/源码（1）.html" class="sidebar-link">源码分析（1）</a></li><li><a href="/learn-blog/dist/note/React/源码（2）.html" class="active sidebar-link">源码分析（2）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/源码（2）.html#reactdom-render" class="sidebar-link">ReactDOM.render</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/源码（2）.html#legacyrendersubtreeintocontainer" class="sidebar-link">legacyRenderSubtreeIntoContainer</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/源码（2）.html#unbatchedupdates" class="sidebar-link">unbatchedUpdates</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/源码（2）.html#updatecontainer" class="sidebar-link">updateContainer</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/源码（2）.html#总结" class="sidebar-link">总结</a></li></ul></li></ul></li><li><a href="/learn-blog/dist/note/React/源码（3）.html" class="sidebar-link">源码分析（3）</a></li><li><a href="/learn-blog/dist/note/React/源码（4）.html" class="sidebar-link">源码（4）</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端图形学</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="源码分析-2"><a href="#源码分析-2" class="header-anchor">#</a> 源码分析（2）</h1> <h2 id="reactdom-render"><a href="#reactdom-render" class="header-anchor">#</a> ReactDOM.render</h2> <p>React 创建更新的三种方式</p> <ul><li>ReactDOM.render || hydrate</li> <li>setState</li> <li>forceUpdate</li></ul> <p>先来讲入口函数 ReactDOM.render</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span>
  <span class="token parameter">element<span class="token operator">:</span> React$Element<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token function">isValidContainer</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token string">'Target container is not a DOM element.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
    <span class="token keyword">null</span><span class="token punctuation">,</span>
    element<span class="token punctuation">,</span>
    container<span class="token punctuation">,</span>
    <span class="token boolean">false</span><span class="token punctuation">,</span>
    callback<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>可以看到直接是调用返回了一个 <strong>legacyRenderSubtreeIntoContainer</strong> 执行的结果</p> <p>其中第四参数写死成false，这个值为true指的是服务端渲染，服务端渲染暂时不分析</p> <h3 id="legacyrendersubtreeintocontainer"><a href="#legacyrendersubtreeintocontainer" class="header-anchor">#</a> legacyRenderSubtreeIntoContainer</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">legacyRenderSubtreeIntoContainer</span><span class="token punctuation">(</span>
  <span class="token parameter">parentComponent<span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  children<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>
  container<span class="token operator">:</span> Container<span class="token punctuation">,</span>
  forceHydrate<span class="token operator">:</span> boolean<span class="token punctuation">,</span>
  callback<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// TODO: Without `any` type, Flow says &quot;Property cannot be accessed on any</span>
  <span class="token comment">// member of intersection type.&quot; Whyyyyyy.</span>
  <span class="token keyword">let</span> root<span class="token operator">:</span> RootType <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>_reactRootContainer<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> fiberRoot<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Initial mount</span>
    root <span class="token operator">=</span> container<span class="token punctuation">.</span>_reactRootContainer <span class="token operator">=</span> <span class="token function">legacyCreateRootFromDOMContainer</span><span class="token punctuation">(</span>
      container<span class="token punctuation">,</span>
      forceHydrate<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
    <span class="token comment">// 封装了callBack函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Initial mount should not be batched.</span>
    <span class="token comment">// 初始化不走批处理逻辑,为了快</span>
    <span class="token function">unbatchedUpdates</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    fiberRoot <span class="token operator">=</span> root<span class="token punctuation">.</span>_internalRoot<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> originalCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">originalCallback</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Update</span>
    <span class="token function">updateContainer</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> fiberRoot<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">getPublicRootInstance</span><span class="token punctuation">(</span>fiberRoot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>这个函数首先会判断是否有root，</p> <ul><li>如果没有root就创建root，然后通过unbatchedUpdates（批处理更新操作）调用updateContainer，创建更新，</li> <li>如果有root，则直接调用updateContainer创建更新</li></ul> <p>创建root (legacyCreateRootFromDOMContainer)主要就是做一个初始化创建FiberRoot的工作，经过了多层的递归，创建FiberRoot、HostFiberRoot，初始化更新队列（UpdateQueue）等等操作。</p> <p>整个调用过程如下：</p> <p><img src="/learn-blog/dist/assets/img/stack1.5564c74b.png" alt="image-20210430141549399"></p> <p>下面是执行完legacyCreateRootFromDOMContainer后的产生数据结构：</p> <p><img src="/learn-blog/dist/assets/img/struct.7b8e4d94.png" alt="image-20210430111458742"></p> <p><code>root</code> 对象被挂载在了 <code>container._reactRootContainer</code> 上，也就是我们的 DOM 容器上。
如果你手边有 React 项目的话，在控制台键入如下代码就可以看到这个 <code>root</code> 对象了。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_reactRootContainer
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong><code>FiberRoot</code> 就是整个 <code>fiber</code> 树的根节点</strong></p> <p>HostRootFiber就是Fiber节点宿主节点，也就Fiber节点的开端，其本身就是一个Fiber节点</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>
<span class="token keyword">function</span> <span class="token function">FiberNode</span><span class="token punctuation">(</span>
  <span class="token parameter">tag<span class="token operator">:</span> WorkTag<span class="token punctuation">,</span>
  pendingProps<span class="token operator">:</span> mixed<span class="token punctuation">,</span>
  key<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>
  mode<span class="token operator">:</span> TypeOfMode<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Instance</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tag <span class="token operator">=</span> tag<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>key <span class="token operator">=</span> key<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>elementType <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token comment">// Fiber</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>return <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>ref <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>pendingProps <span class="token operator">=</span> pendingProps<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedProps <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>memoizedState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>dependencies <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>mode <span class="token operator">=</span> mode<span class="token punctuation">;</span>

  <span class="token comment">// Effects</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>flags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>subtreeFlags <span class="token operator">=</span> NoFlags<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>deletions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>lanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>childLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>alternate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><h4 id="fiber结构"><a href="#fiber结构" class="header-anchor">#</a> Fiber结构</h4> <p>从上面的代码可看到Fiber节点的大致结构，<code>return</code>、<code>child</code>、<code>sibling</code> 这三个属性很重要，它们是构成 <code>fiber</code> 树的主体数据结构。<code>fiber</code> 树其实是一个链表树结构，<code>return</code> 及 <code>child</code> 分别对应着树的父子节点，并且父节点只有一个 <code>child</code> 指向它的第一个子节点，即便是父节点有好多个子节点。那么多个子节点如何连接起来呢？答案是 <code>sibling</code>，每个子节点都有一个 <code>sibling</code> 属性指向着下一个子节点，都有一个 <code>return</code> 属性指向着父节点。</p> <p><img src="/learn-blog/dist/assets/img/fiber.563a2767.png" alt="See the source image"></p> <h3 id="unbatchedupdates"><a href="#unbatchedupdates" class="header-anchor">#</a> unbatchedUpdates</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 执行非批量更新的操作</span>
<span class="token comment">// 主题逻辑： 保存初始上下文，增加非批量上下文，删除批量更新上下文， 执行函数， 重置上下文，重置时间和执行同步队列</span>
<span class="token comment">//  unbatchedUpdates 存储当前上下文，去除批量上下文，增加非批量更新上下文，执行函数fn, 结束后，还原上下文，当无上下文，重置渲染时间和清空同步回调函数。</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> unbatchedUpdates<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">R</span><span class="token punctuation">,</span> a<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">R</span> <span class="token punctuation">{</span>
  <span class="token comment">// 原来的执行上下文</span>
  <span class="token comment">// BatchedContext = 0b000001</span>
  <span class="token comment">// LegacyUnbatchedContext = 0b001000</span>
  <span class="token comment">// executionContext = 0b001000 = 8</span>
  <span class="token comment">// 0b000000 &amp; 0b111110</span>
  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span> <span class="token comment">// 获取当前上下文 // 0b000000 </span>
  executionContext <span class="token operator">&amp;=</span> <span class="token operator">~</span>BatchedContext<span class="token punctuation">;</span>  <span class="token comment">// 去除批量更新的标记 1</span>
  executionContext <span class="token operator">|=</span> LegacyUnbatchedContext<span class="token punctuation">;</span>  <span class="token comment">// 增加非批量执行上下文 8</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 执行函数 updateContainer(children, fiberRoot, parentComponent, callback);</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span> <span class="token comment">// 保存原来的执行参数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executionContext <span class="token operator">===</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 无上下文时</span>
      <span class="token comment">// Flush the immediate callbacks that were scheduled during this batch</span>
      <span class="token function">resetRenderTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 重置渲染时间</span>
      <span class="token comment">// 首次执行不会进入flushSyncCallbackQueue先不展开</span>
      <span class="token comment">// 刷新次批调度任务中的立即回调函数</span>
      <span class="token comment">// 首次执行不会进入flushSyncCallbackQueue先不展开</span>
      <span class="token comment">// 刷新次批调度任务中的立即清空函数</span>
      <span class="token function">flushSyncCallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="updatecontainer"><a href="#updatecontainer" class="header-anchor">#</a> updateContainer</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 主体逻辑： 新建lane 和eventTime， 获取context, 开始进行调度</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">updateContainer</span><span class="token punctuation">(</span>
  element<span class="token operator">:</span> ReactNodeList<span class="token punctuation">,</span>  <span class="token comment">// children </span>
  container<span class="token operator">:</span> OpaqueRoot<span class="token punctuation">,</span>   <span class="token comment">// fiberRoot 节点</span>
  parentComponent<span class="token operator">:</span> <span class="token operator">?</span>React$Component<span class="token operator">&lt;</span>any<span class="token punctuation">,</span> any<span class="token operator">&gt;</span><span class="token punctuation">,</span>  <span class="token comment">// null </span>
  callback<span class="token operator">:</span> <span class="token operator">?</span>Function<span class="token punctuation">,</span>  <span class="token comment">// 回调函数</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Lane <span class="token punctuation">{</span>
  <span class="token comment">// RootFiber 节点</span>
  <span class="token keyword">const</span> current <span class="token operator">=</span> container<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token comment">// 获取eventTime 时间  // deferRenderPhaseUpdateToNextBatch</span>
  <span class="token keyword">const</span> eventTime <span class="token operator">=</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取lane 优先级</span>
  <span class="token keyword">const</span> lane <span class="token operator">=</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 可以忽略</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>enableSchedulingProfiler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">markRenderScheduled</span><span class="token punctuation">(</span>lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// parentComponent  ：  null</span>
  <span class="token comment">// 获取当前节点和子节点的上下文</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token function">getContextForSubtree</span><span class="token punctuation">(</span>parentComponent<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>container<span class="token punctuation">.</span>context <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token comment">// fiberRoot.context = {}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span>pendingContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 创建更新 // 创建一个更新对象</span>
  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>eventTime<span class="token punctuation">,</span> lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Caution: React DevTools currently depends on this property</span>
  <span class="token comment">// being called &quot;element&quot;.</span>
  update<span class="token punctuation">.</span>payload <span class="token operator">=</span> <span class="token punctuation">{</span> element <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// 更新的payload children reactNode</span>

  <span class="token comment">// 回调函数</span>
  callback <span class="token operator">=</span> callback <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> callback<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 设置回调函数</span>
    update<span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 插入更新  将update放进current的updateQueue.share.pending中</span>
  <span class="token comment">//  1、 update.next = next   2、 current.updateQueue.share.pending = update</span>
  <span class="token function">enqueueUpdate</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 进行调度</span>
  <span class="token comment">// 当前的fiber, lane 时间</span>
  <span class="token comment">// 没有在 非（commit  render） 或在 commit , 才需要进行调度</span>
  <span class="token function">scheduleUpdateOnFiber</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> lane<span class="token punctuation">,</span> eventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> lane<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><p>设置当前事件时间</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// executionContext = 0b001000</span>
<span class="token comment">// RenderContext = 0b010000;</span>
<span class="token comment">// CommitContext = 0b100000;</span>
<span class="token comment">// 主体逻辑： 1,为render, commit阶段，获取当前时间， 2 .其他阶段时间为，统一的时间，批量更新  </span>
<span class="token comment">// 3  初始化阶段， 初次获取的时候，获取当前时间</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">requestEventTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 执行的上下文是render或者commit，在执行阶段获取真实时间, 当正在 处于render 或者commit 阶段的时候, 就是当前水岸i</span>
  <span class="token comment">// 情况 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RenderContext <span class="token operator">|</span> CommitContext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// We're inside React, so it's fine to read the actual time.</span>
    <span class="token keyword">return</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// We're not inside React, so we may be in the middle of a browser event.</span>
  <span class="token comment">// 非commit  或render 时间啊， 当不为空。 取当前event 时间</span>
  <span class="token comment">// 如果我们没在react内部更新中，可能是在执行浏览器的任务中</span>
  <span class="token comment">// 我们不在React内部，因此我们可能处于浏览器事件的中间。</span>
  <span class="token comment">// 情况2</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentEventTime <span class="token operator">!==</span> NoTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Use the same start time for all updates until we enter React again.</span>
    <span class="token keyword">return</span> currentEventTime<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// This is the first update since React yielded. Compute a new start time.</span>
  <span class="token comment">// 第一次更新的时候</span>
  <span class="token comment">// 之前的任务已经执行完，开启新的任务时候需要重新计算时间</span>
  <span class="token comment">// 情况3</span>
  <span class="token comment">// This is the first update since React yielded. Compute a new start time.</span>
  currentEventTime <span class="token operator">=</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> currentEventTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>设置优先级</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 获取请求更新的Lane</span>
<span class="token comment">// 主体逻辑： 当普通初始化，为同步，其次</span>
<span class="token comment">// 情况1 非BlockingMode 模式， 同步</span>
<span class="token comment">// 情况2 非BlockingMode 且非ConcurrentMode模式， 通过getCurrentPriorityLevel 判断，</span>
<span class="token comment">// 是同步还是批量同步</span>
<span class="token comment">// 情况3 </span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">requestUpdateLane</span><span class="token punctuation">(</span><span class="token parameter">fiber<span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Lane <span class="token punctuation">{</span>
  <span class="token comment">// Special cases</span>
  <span class="token comment">// Special cases</span>
  <span class="token comment">// fiber de mode格式</span>
  <span class="token keyword">const</span> mode <span class="token operator">=</span> fiber<span class="token punctuation">.</span>mode<span class="token punctuation">;</span>
  <span class="token comment">// 旧模式中lane只为SyncLane = 1</span>
  <span class="token comment">// 当与 BlockingMode   BlockingMode = 0b00010;</span>
  <span class="token comment">// 当为 非BlockingMode 模式， 就是同步</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> BlockingMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 同步的  旧模式中lane只为SyncLane = 1</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>SyncLane<span class="token operator">:</span> Lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// 模式为非 ConcurrentMode 模式</span>
    <span class="token keyword">return</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> ImmediateSchedulerPriority
      <span class="token operator">?</span> <span class="token punctuation">(</span>SyncLane<span class="token operator">:</span> Lane<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span>SyncBatchedLane<span class="token operator">:</span> Lane<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token operator">!</span>deferRenderPhaseUpdateToNextBatch <span class="token operator">&amp;&amp;</span>
    <span class="token punctuation">(</span>executionContext <span class="token operator">&amp;</span> RenderContext<span class="token punctuation">)</span> <span class="token operator">!==</span> NoContext <span class="token operator">&amp;&amp;</span>
    workInProgressRootRenderLanes <span class="token operator">!==</span> NoLanes
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 渲染阶段</span>
    <span class="token comment">// This is a render phase update. These are not officially supported. The</span>
    <span class="token comment">// old behavior is to give this the same &quot;thread&quot; (expiration time) as</span>
    <span class="token comment">// whatever is currently rendering. So if you call `setState` on a component</span>
    <span class="token comment">// that happens later in the same render, it will flush. Ideally, we want to</span>
    <span class="token comment">// remove the special case and treat them as if they came from an</span>
    <span class="token comment">// interleaved event. Regardless, this pattern is not officially supported.</span>
    <span class="token comment">// This behavior is only a fallback. The flag only exists until we can roll</span>
    <span class="token comment">// out the setState warning, since existing code might accidentally rely on</span>
    <span class="token comment">// the current behavior.</span>
    <span class="token comment">// Arbitrary 任意的</span>
    <span class="token keyword">return</span> <span class="token function">pickArbitraryLane</span><span class="token punctuation">(</span>workInProgressRootRenderLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// The algorithm for assigning an update to a lane should be stable for all</span>
  <span class="token comment">// updates at the same priority within the same event. To do this, the inputs</span>
  <span class="token comment">// to the algorithm must be the same. For example, we use the `renderLanes`</span>
  <span class="token comment">// to avoid choosing a lane that is already in the middle of rendering.</span>
  <span class="token comment">//</span>
  <span class="token comment">// However, the &quot;included&quot; lanes could be mutated in between updates in the</span>
  <span class="token comment">// same event, like if you perform an update inside `flushSync`. Or any other</span>
  <span class="token comment">// code path that might call `prepareFreshStack`.</span>
  <span class="token comment">//</span>
  <span class="token comment">// The trick we use is to cache the first of each of these inputs within an</span>
  <span class="token comment">// event. Then reset the cached values once we can be sure the event is over.</span>
  <span class="token comment">// Our heuristic for that is whenever we enter a concurrent work loop.</span>
  <span class="token comment">//</span>
  <span class="token comment">// We'll do the same for `currentEventPendingLanes` below.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentEventWipLanes <span class="token operator">===</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentEventWipLanes <span class="token operator">=</span> workInProgressRootIncludedLanes<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> isTransition <span class="token operator">=</span> <span class="token function">requestCurrentTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!==</span> NoTransition<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isTransition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentEventPendingLanes <span class="token operator">!==</span> NoLanes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentEventPendingLanes <span class="token operator">=</span>
        mostRecentlyUpdatedRoot <span class="token operator">!==</span> <span class="token keyword">null</span>
          <span class="token operator">?</span> mostRecentlyUpdatedRoot<span class="token punctuation">.</span>pendingLanes
          <span class="token operator">:</span> NoLanes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">findTransitionLane</span><span class="token punctuation">(</span>currentEventWipLanes<span class="token punctuation">,</span> currentEventPendingLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><p>通过<code>const update = createUpdate(eventTime, lane);</code>将前面获取的时间与优先级作为参数，创建更新对象，更新对象结果如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> update<span class="token operator">:</span> Update<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    eventTime<span class="token punctuation">,</span> <span class="token comment">// 事件时间</span>
    lane<span class="token punctuation">,</span>
    <span class="token comment">// export const UpdateState = 0;</span>
 <span class="token comment">// export const ReplaceState = 1;</span>
 <span class="token comment">// export const ForceUpdate = 2;</span>
 <span class="token comment">// export const CaptureUpdate = 3;  // 渲染出现问题，被捕获后， 渲染新的状态</span>
 <span class="token comment">// 指定更新的类型，值为以上几种</span>

    tag<span class="token operator">:</span> UpdateState<span class="token punctuation">,</span> <span class="token comment">// 普通的更新， 更新类型</span>
    <span class="token comment">// 更新内容，比如`setState`接收的第一个参数</span>
    payload<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    callback<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token comment">// 指向下一个更新</span>
    next<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>updateContainer 做了以下几件事情</p> <ol><li>拿到 FiberNode</li> <li>设置 eventTime,设置lane优先级</li> <li>新建一个 uodate 并添加到 enqueueUpdate 里面</li> <li>执行调度 scheduleWork</li></ol> <h3 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h3> <p><img src="/learn-blog/dist/assets/img/React2.8680c8b3.png" alt="React源码2"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">5/13/2021, 12:17:55 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learn-blog/dist/note/React/源码（1）.html" class="prev">
        源码分析（1）
      </a></span> <span class="next"><a href="/learn-blog/dist/note/React/源码（3）.html">
        源码分析（3）
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><section class="side-anchor"><ul style="display:none;"></ul></section></div></div>
    <script src="/learn-blog/dist/assets/js/app.f2b1e5cd.js" defer></script><script src="/learn-blog/dist/assets/js/2.9615dc11.js" defer></script><script src="/learn-blog/dist/assets/js/5.0866854b.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>合成事件 | BINGO BLOG</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/learn-blog/dist/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
    <meta name="description" content="BINGO BLOG 学然后知不足 非淡泊无以明志，非宁静无以致远">
    <meta name="keywords" content="博客，前端，代码，个人博客，学习，兴趣，BINGOBLOG">
    
    <link rel="preload" href="/learn-blog/dist/assets/css/0.styles.4b1e8fc9.css" as="style"><link rel="preload" href="/learn-blog/dist/assets/js/app.32413baa.js" as="script"><link rel="preload" href="/learn-blog/dist/assets/js/2.0abb358e.js" as="script"><link rel="preload" href="/learn-blog/dist/assets/js/81.740caffe.js" as="script"><link rel="prefetch" href="/learn-blog/dist/assets/js/10.2eb385a0.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/100.e1155413.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/11.c5664e3c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/12.813cf92a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/13.fab5a0ec.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/14.dac499ad.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/15.00a9a19c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/16.50aa149f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/17.9904fdf1.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/18.f8a22dad.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/19.16629a94.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/20.968bb718.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/21.ec8cba7c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/22.0569e639.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/23.a5e60b48.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/24.82974bf7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/25.26e8e18b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/26.2a18b89e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/27.1f6dcdb6.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/28.b33e138c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/29.68e39dd8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/3.30c5ca96.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/30.ac2eff19.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/31.3026d128.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/32.56c051a6.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/33.b94f906f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/34.eb4915bc.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/35.b5cbc220.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/36.47826e4a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/37.50186b53.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/38.c8e89072.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/39.c2e0a838.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/4.9ffda502.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/40.7067b9a7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/41.068e4968.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/42.8b23c551.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/43.5ce03d7d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/44.ff2fc255.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/45.e79d9f4b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/46.8361f01e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/47.0a8324ac.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/48.99e54fba.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/49.38276a69.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/5.9476e8d5.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/50.4b434779.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/51.ff8c8795.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/52.ca58afa9.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/53.05490a57.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/54.44f8e498.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/55.06e43524.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/56.1d6d26ce.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/57.a6d719ad.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/58.d64e2482.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/59.279a1733.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/6.38546333.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/60.de3afb04.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/61.5ef3d691.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/62.653b231b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/63.d9ff1ce4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/64.a7ce38ed.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/65.cbe564fe.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/66.01518500.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/67.ae5d4bb7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/68.374587d3.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/69.0a681840.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/7.6a894948.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/70.73af9a17.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/71.270ae671.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/72.9ee69fbc.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/73.7b59e278.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/74.36784a47.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/75.54718508.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/76.7fb38271.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/77.a2941cf5.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/78.b81dcef9.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/79.473e2978.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/8.eb853009.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/80.2b7b0581.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/82.c4f72170.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/83.f6da3511.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/84.305dc49c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/85.1ba0adb2.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/86.28817859.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/87.dd156b96.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/88.5f7ba5c6.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/89.898644f7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/9.5c52f652.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/90.4947f517.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/91.1d6c58a4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/92.d906de8d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/93.cef56fd4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/94.063f7c5e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/95.572bd990.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/96.9aa30b24.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/97.5a60ef56.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/98.52a698f8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/99.325eb397.js">
    <link rel="stylesheet" href="/learn-blog/dist/assets/css/0.styles.4b1e8fc9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-blog/dist/" class="home-link router-link-active"><img src="/learn-blog/dist/logo.png" alt="BINGO BLOG" class="logo"> <span class="site-name can-hide">BINGO BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/learn-blog/dist/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/learn-blog/dist/algorithm/" class="nav-link">
  算法
</a></div> <a href="https://github.com/bingoYB/learn-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/learn-blog/dist/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/learn-blog/dist/algorithm/" class="nav-link">
  算法
</a></div> <a href="https://github.com/bingoYB/learn-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程思想</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-blog/dist/note/React/合成事件.html" class="active sidebar-link">合成事件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#描述" class="sidebar-link">描述</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#react事件系统" class="sidebar-link">React事件系统</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#事件注册" class="sidebar-link">事件注册</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#事件存储" class="sidebar-link">事件存储</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#事件合成" class="sidebar-link">事件合成</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#事件分发" class="sidebar-link">事件分发</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#事件执行" class="sidebar-link">事件执行</a></li></ul></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#" class="sidebar-link"></a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/React/合成事件.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/learn-blog/dist/note/React/手写redux.html" class="sidebar-link">手写Redux</a></li><li><a href="/learn-blog/dist/note/React/源码（1）.html" class="sidebar-link">源码分析（1）</a></li><li><a href="/learn-blog/dist/note/React/源码（2）.html" class="sidebar-link">源码分析（2）</a></li><li><a href="/learn-blog/dist/note/React/源码（3）.html" class="sidebar-link">源码分析（3）</a></li><li><a href="/learn-blog/dist/note/React/源码（4）.html" class="sidebar-link">源码（4）</a></li><li><a href="/learn-blog/dist/note/React/理解Redux.html" class="sidebar-link">Redux的理解</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端图形学</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="合成事件"><a href="#合成事件" class="header-anchor">#</a> 合成事件</h1> <h2 id="描述"><a href="#描述" class="header-anchor">#</a> 描述</h2> <p><code>React</code>的合成事件<code>SyntheticEvent</code>实际上就是<code>React</code>自己在内部实现的一套事件处理机制，它是浏览器的原生事件的跨浏览器包装器，除兼容所有浏览器外，它还拥有和浏览器原生事件相同的接口，包括<code>stopPropagation()</code>和<code>preventDefault()</code>，合成事件与浏览器的原生事件不同，也不会直接映射到原生事件，也就是说通常不要使用<code>addEventListener</code>为已创建的<code>DOM</code>元素添加监听器，而应该直接使用<code>React</code>中定义的事件机制，而且在混用的情况下原生事件如果定义了阻止冒泡可能会阻止合成事件的执行，当然如果确实需要使用原生事件去处理需求，可以通过事件触发传递的<code>SyntheticEvent</code>对象的<code>nativeEvent</code>属性获得原生<code>Event</code>对象的引用，<code>React</code>中的事件有以下几个特点：</p> <ul><li><code>React</code>上注册的事件最终会绑定在<code>document</code>这个<code>DOM</code>上，而不是<code>React</code>组件对应的<code>DOM</code>，通过这种方式减少内存开销，所有的事件都绑定在<code>document</code>上，其他节点没有绑定事件，实际上就是事件委托的。</li> <li><code>React</code>自身实现了一套事件冒泡机制，使用<code>React</code>实现的<code>Event</code>对象与原生<code>Event</code>对象不同，不能相互混用。</li> <li><code>React</code>通过队列的形式，从触发的组件向父组件回溯，然后调用他们<code>JSX</code>中定义的<code>callback</code>。</li> <li><code>React</code>的合成事件<code>SyntheticEvent</code>与浏览器的原生事件不同，也不会直接映射到原生事件。</li> <li><code>React</code>通过对象池的形式管理合成事件对象的创建和销毁，减少了垃圾的生成和新对象内存的分配，提高了性能。</li></ul> <p>对于每个<code>SyntheticEvent</code>对象都包含以下属性：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>boolean bubbles
boolean cancelable
DOMEventTarget currentTarget
boolean defaultPrevented
number eventPhase
boolean isTrusted
DOMEvent nativeEvent
void preventDefault()
boolean isDefaultPrevented()
void stopPropagation()
boolean isPropagationStopped()
void persist()
DOMEventTarget target
number timeStamp
string type
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>支持的合成事件一览，注意以下的事件处理函数在冒泡阶段被触发，如需注册捕获阶段的事件处理函数，则应为事件名添加<code>Capture</code>，例如处理捕获阶段的点击事件请使用<code>onClickCapture</code>，而不是<code>onClick</code></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- 剪贴板事件 --&gt;</span>
onCopy onCut onPaste

<span class="token comment">&lt;!-- 复合事件 --&gt;</span>
onCompositionEnd onCompositionStart onCompositionUpdate

<span class="token comment">&lt;!-- 键盘事件 --&gt;</span>
onKeyDown onKeyPress onKeyUp

<span class="token comment">&lt;!-- 焦点事件 --&gt;</span>
onFocus onBlur

<span class="token comment">&lt;!-- 表单事件 --&gt;</span>
onChange onInput onInvalid onReset onSubmit 

<span class="token comment">&lt;!-- 通用事件 --&gt;</span>
onError onLoad

<span class="token comment">&lt;!-- 鼠标事件 --&gt;</span>
onClick onContextMenu onDoubleClick onDrag onDragEnd onDragEnter onDragExit
onDragLeave onDragOver onDragStart onDrop onMouseDown onMouseEnter onMouseLeave
onMouseMove onMouseOut onMouseOver onMouseUp

<span class="token comment">&lt;!-- 指针事件 --&gt;</span>
onPointerDown onPointerMove onPointerUp onPointerCancel onGotPointerCapture
onLostPointerCapture onPointerEnter onPointerLeave onPointerOver onPointerOut

<span class="token comment">&lt;!-- 选择事件 --&gt;</span>
onSelect

<span class="token comment">&lt;!-- 触摸事件 --&gt;</span>
onTouchCancel onTouchEnd onTouchMove onTouchStart

<span class="token comment">&lt;!-- UI 事件 --&gt;</span>
onScroll

<span class="token comment">&lt;!-- 滚轮事件 --&gt;</span>
onWheel

<span class="token comment">&lt;!-- 媒体事件 --&gt;</span>
onAbort onCanPlay onCanPlayThrough onDurationChange onEmptied onEncrypted
onEnded onError onLoadedData onLoadedMetadata onLoadStart onPause onPlay
onPlaying onProgress onRateChange onSeeked onSeeking onStalled onSuspend
onTimeUpdate onVolumeChange onWaiting

<span class="token comment">&lt;!-- 图像事件 --&gt;</span>
onLoad onError

<span class="token comment">&lt;!-- 动画事件 --&gt;</span>
onAnimationStart onAnimationEnd onAnimationIteration

<span class="token comment">&lt;!-- 过渡事件 --&gt;</span>
onTransitionEnd

<span class="token comment">&lt;!-- 其他事件 --&gt;</span>
onToggle

<span class="token comment">&lt;!-- https://zh-hans.reactjs.org/docs/events.html --&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br></div></div><h2 id="react事件系统"><a href="#react事件系统" class="header-anchor">#</a> React事件系统</h2> <p>简单来说，在挂载的时候，通过<code>listenerBank</code>把事件存起来了，触发的时候<code>document</code>进行<code>dispatchEvent</code>，找到触发事件的最深的一个节点，向上遍历拿到所有的<code>callback</code>放在<code>eventQueue</code>，根据事件类型构建<code>event</code>对象，遍历执行<code>eventQueue</code>，不简单点说，我们可以查看一下<code>React</code>对于事件处理的源码实现，<code>commit id</code>为<code>4ab6305</code>，<code>TAG</code>是<code>React16.10.2</code>，在<code>React17</code>不再往<code>document</code>上挂事件委托，而是挂到<code>DOM</code>容器上，目录结构都有了很大更改，我们还是依照<code>React16</code>，首先来看一下事件的处理流程。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>/**
 * React和事件系统概述:
 *
 * +------------+    <span class="token builtin class-name">.</span>
 * <span class="token operator">|</span>    DOM     <span class="token operator">|</span>    <span class="token builtin class-name">.</span>
 * +------------+    <span class="token builtin class-name">.</span>
 *       <span class="token operator">|</span>           <span class="token builtin class-name">.</span>
 *       <span class="token function">v</span>           <span class="token builtin class-name">.</span>
 * +------------+    <span class="token builtin class-name">.</span>
 * <span class="token operator">|</span> ReactEvent <span class="token operator">|</span>    <span class="token builtin class-name">.</span>
 * <span class="token operator">|</span>  Listener  <span class="token operator">|</span>    <span class="token builtin class-name">.</span>
 * +------------+    <span class="token builtin class-name">.</span>                         +-----------+
 *       <span class="token operator">|</span>           <span class="token builtin class-name">.</span>               +--------+<span class="token operator">|</span>SimpleEvent<span class="token operator">|</span>
 *       <span class="token operator">|</span>           <span class="token builtin class-name">.</span>               <span class="token operator">|</span>         <span class="token operator">|</span>Plugin     <span class="token operator">|</span>
 * +-----<span class="token operator">|</span>------+    <span class="token builtin class-name">.</span>               <span class="token function">v</span>         +-----------+
 * <span class="token operator">|</span>     <span class="token operator">|</span>      <span class="token operator">|</span>    <span class="token builtin class-name">.</span>    +--------------+                    +------------+
 * <span class="token operator">|</span>     +-----------.---<span class="token operator">&gt;|</span>EventPluginHub<span class="token operator">|</span>                    <span class="token operator">|</span>    Event   <span class="token operator">|</span>
 * <span class="token operator">|</span>            <span class="token operator">|</span>    <span class="token builtin class-name">.</span>    <span class="token operator">|</span>              <span class="token operator">|</span>     +-----------+  <span class="token operator">|</span> Propagators<span class="token operator">|</span>
 * <span class="token operator">|</span> ReactEvent <span class="token operator">|</span>    <span class="token builtin class-name">.</span>    <span class="token operator">|</span>              <span class="token operator">|</span>     <span class="token operator">|</span>TapEvent   <span class="token operator">|</span>  <span class="token operator">|</span>------------<span class="token operator">|</span>
 * <span class="token operator">|</span>  Emitter   <span class="token operator">|</span>    <span class="token builtin class-name">.</span>    <span class="token operator">|</span>              <span class="token operator">|</span><span class="token operator">&lt;</span>---+<span class="token operator">|</span>Plugin     <span class="token operator">|</span>  <span class="token operator">|</span>other plugin<span class="token operator">|</span>
 * <span class="token operator">|</span>            <span class="token operator">|</span>    <span class="token builtin class-name">.</span>    <span class="token operator">|</span>              <span class="token operator">|</span>     +-----------+  <span class="token operator">|</span>  utilities <span class="token operator">|</span>
 * <span class="token operator">|</span>     +-----------.---<span class="token operator">&gt;|</span>              <span class="token operator">|</span>                    +------------+
 * <span class="token operator">|</span>     <span class="token operator">|</span>      <span class="token operator">|</span>    <span class="token builtin class-name">.</span>    +--------------+
 * +-----<span class="token operator">|</span>------+    <span class="token builtin class-name">.</span>                ^        +-----------+
 *       <span class="token operator">|</span>           <span class="token builtin class-name">.</span>                <span class="token operator">|</span>        <span class="token operator">|</span>Enter/Leave<span class="token operator">|</span>
 *       +           <span class="token builtin class-name">.</span>                +-------+<span class="token operator">|</span>Plugin     <span class="token operator">|</span>
 * +-------------+   <span class="token builtin class-name">.</span>                         +-----------+
 * <span class="token operator">|</span> application <span class="token operator">|</span>   <span class="token builtin class-name">.</span>
 * <span class="token operator">|</span>-------------<span class="token operator">|</span>   <span class="token builtin class-name">.</span>
 * <span class="token operator">|</span>             <span class="token operator">|</span>   <span class="token builtin class-name">.</span>
 * <span class="token operator">|</span>             <span class="token operator">|</span>   <span class="token builtin class-name">.</span>
 * +-------------+   <span class="token builtin class-name">.</span>
 *                   <span class="token builtin class-name">.</span>
 */
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>在<code>packages\react-dom\src\events\ReactBrowserEventEmitter.js</code>中就描述了上边的流程，并且还有相应的英文注释，使用<code>google</code>翻译一下，这个太概述了，所以还是需要详细描述一下，在事件处理之前，我们编写的<code>JSX</code>需要经过<code>babel</code>的编译，创建虚拟<code>DOM</code>，并处理组件<code>props</code>，拿到事件类型和回调<code>fn</code>等，之后便是事件注册、存储、合成、分发、执行阶段。</p> <ul><li><code>Top-level delegation</code>用于捕获最原始的浏览器事件，它主要由<code>ReactEventListener</code>负责，<code>ReactEventListener</code>被注入后可以支持插件化的事件源，这一过程发生在主线程。</li> <li><code>React</code>对事件进行规范化和重复数据删除，以解决浏览器的问题，这可以在工作线程中完成。</li> <li>将这些本地事件(具有关联的顶级类型用来捕获它)转发到<code>EventPluginHub</code>，后者将询问插件是否要提取任何合成事件。</li> <li>然后<code>EventPluginHub</code>将通过为每个事件添加<code>dispatches</code>(引用该事件的侦听器和<code>ID</code>的序列)来对其进行注释来进行处理。</li> <li>再接着，<code>EventPluginHub</code>会调度分派事件。</li></ul> <h3 id="事件注册"><a href="#事件注册" class="header-anchor">#</a> 事件注册</h3> <p>首先会调用<code>setInitialDOMProperties()</code>判断是否在<code>registrationNameModules</code>列表中，在的话便注册事件，列表包含了可以注册的事件。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// packages\react-dom\src\client\ReactDOMComponent.js line 308</span>
<span class="token keyword">function</span> <span class="token function">setInitialDOMProperties</span><span class="token punctuation">(</span>
  <span class="token parameter">tag<span class="token operator">:</span> string<span class="token punctuation">,</span>
  domElement<span class="token operator">:</span> Element<span class="token punctuation">,</span>
  rootContainerElement<span class="token operator">:</span> Element <span class="token operator">|</span> Document<span class="token punctuation">,</span>
  nextProps<span class="token operator">:</span> Object<span class="token punctuation">,</span>
  isCustomComponentTag<span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> propKey <span class="token keyword">in</span> nextProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nextProps<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> nextProp <span class="token operator">=</span> nextProps<span class="token punctuation">[</span>propKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propKey <span class="token operator">===</span> <span class="token constant">STYLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// Freeze the next style object so that we can assume it won't be</span>
          <span class="token comment">// mutated. We have already warned for this in the past.</span>
          Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span>nextProp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Relies on `updateStylesByID` not mutating `styleUpdates`.</span>
      <span class="token function">setValueForStyles</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> nextProp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>registrationNameModules<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span>propKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 对事件名进行合法性检验，只有合法的事件名才会被识别并进行事件绑定</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__ <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> nextProp <span class="token operator">!==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warnForInvalidEventListener</span><span class="token punctuation">(</span>propKey<span class="token punctuation">,</span> nextProp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">ensureListeningTo</span><span class="token punctuation">(</span>rootContainerElement<span class="token punctuation">,</span> propKey<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开始注册事件</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nextProp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setValueForProperty</span><span class="token punctuation">(</span>domElement<span class="token punctuation">,</span> propKey<span class="token punctuation">,</span> nextProp<span class="token punctuation">,</span> isCustomComponentTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>如果事件名合法而且是一个函数的时候，就会调用<code>ensureListeningTo()</code>方法注册事件。<code>ensureListeningTo</code>会判断<code>rootContainerElement</code>是否为<code>document</code>或是<code>Fragment</code>，如果是则直接传递给<code>listenTo</code>，如果不是则通过<code>ownerDocument</code>来获取其根节点，对于<code>ownerDocument</code>属性，定义是这样的，<code>ownerDocument</code>可返回某元素的根元素，在<code>HTML</code>中<code>HTML</code>文档本身是元素的根元素，所以可以说明其实大部分的事件都是注册在<code>document</code>上面的，之后便是调用<code>listenTo</code>方法实际注册。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\react-dom\src\client\ReactDOMComponent.js line 272</span>
<span class="token keyword">function</span> <span class="token function">ensureListeningTo</span><span class="token punctuation">(</span>
  <span class="token parameter">rootContainerElement<span class="token operator">:</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span>
  registrationName<span class="token operator">:</span> string<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isDocumentOrFragment <span class="token operator">=</span>
    rootContainerElement<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_NODE</span> <span class="token operator">||</span>
    rootContainerElement<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token constant">DOCUMENT_FRAGMENT_NODE</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> doc <span class="token operator">=</span> isDocumentOrFragment
    <span class="token operator">?</span> rootContainerElement
    <span class="token operator">:</span> rootContainerElement<span class="token punctuation">.</span>ownerDocument<span class="token punctuation">;</span>
  <span class="token function">listenTo</span><span class="token punctuation">(</span>registrationName<span class="token punctuation">,</span> doc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>在<code>listenTo()</code>方法中比较重要的就是<code>registrationNameDependencies</code>的概念，对于不同的事件，<code>React</code>会同时绑定多个事件来达到统一的效果。此外<code>listenTo()</code>方法还默认将事件通过<code>trapBubbledEvent</code>绑定，将<code>onBlur</code>、<code>onFocus</code>、<code>onScroll</code>等事件通过<code>trapCapturedEvent</code>绑定，因为这些事件没有冒泡行为，<code>invalid</code>、<code>submit</code>、<code>reset</code>事件以及媒体等事件绑定到当前<code>DOM</code>上。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\react-dom\src\events\ReactBrowserEventEmitter.js line 128</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">listenTo</span><span class="token punctuation">(</span>
  registrationName<span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token comment">// 事件的名称，即为上面的propKey(如onClick)</span>
  mountAt<span class="token operator">:</span> Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span> <span class="token comment">// 事件注册的目标容器</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取目标容器已经挂载的事件列表对象，如果没有则初始化为空对象</span>
  <span class="token keyword">const</span> listeningSet <span class="token operator">=</span> <span class="token function">getListeningSetForElement</span><span class="token punctuation">(</span>mountAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取对应事件的依赖事件，比如onChange会依赖TOP_INPUT、TOP_FOCUS等一系列事件</span>
  <span class="token keyword">const</span> dependencies <span class="token operator">=</span> registrationNameDependencies<span class="token punctuation">[</span>registrationName<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
   <span class="token comment">// 遍历所有的依赖，并挨个进行绑定</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dependency <span class="token operator">=</span> dependencies<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">listenToTopLevel</span><span class="token punctuation">(</span>dependency<span class="token punctuation">,</span> mountAt<span class="token punctuation">,</span> listeningSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">listenToTopLevel</span><span class="token punctuation">(</span>
  <span class="token parameter">topLevelType<span class="token operator">:</span> DOMTopLevelEventType<span class="token punctuation">,</span>
  mountAt<span class="token operator">:</span> Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span>
  listeningSet<span class="token operator">:</span> Set<span class="token operator">&lt;</span>DOMTopLevelEventType <span class="token operator">|</span> string<span class="token operator">&gt;</span><span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>listeningSet<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 针对不同的事件来判断使用事件捕获还是事件冒泡</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token constant">TOP_SCROLL</span><span class="token operator">:</span>
        <span class="token function">trapCapturedEvent</span><span class="token punctuation">(</span><span class="token constant">TOP_SCROLL</span><span class="token punctuation">,</span> mountAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">TOP_FOCUS</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token constant">TOP_BLUR</span><span class="token operator">:</span>
        <span class="token function">trapCapturedEvent</span><span class="token punctuation">(</span><span class="token constant">TOP_FOCUS</span><span class="token punctuation">,</span> mountAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">trapCapturedEvent</span><span class="token punctuation">(</span><span class="token constant">TOP_BLUR</span><span class="token punctuation">,</span> mountAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// We set the flag for a single dependency later in this function,</span>
        <span class="token comment">// but this ensures we mark both as attached rather than just one.</span>
        listeningSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">TOP_BLUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        listeningSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token constant">TOP_FOCUS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">TOP_CANCEL</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token constant">TOP_CLOSE</span><span class="token operator">:</span>
        <span class="token comment">// getRawEventName会返回真实的事件名称，比如onChange =&gt; onchange</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEventSupported</span><span class="token punctuation">(</span><span class="token function">getRawEventName</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">trapCapturedEvent</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">,</span> mountAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">TOP_INVALID</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token constant">TOP_SUBMIT</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token constant">TOP_RESET</span><span class="token operator">:</span>
        <span class="token comment">// We listen to them on the target DOM elements.</span>
        <span class="token comment">// Some of them bubble so we don't want them to fire twice.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token comment">// 默认将除了媒体事件之外的所有事件都注册冒泡事件</span>
        <span class="token comment">// 因为媒体事件不会冒泡，所以注册冒泡事件毫无意义</span>
        <span class="token keyword">const</span> isMediaEvent <span class="token operator">=</span> mediaEventTypes<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isMediaEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">trapBubbledEvent</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">,</span> mountAt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 表示目标容器已经注册了该事件</span>
    listeningSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>之后就是熟知的对事件的绑定，以事件冒泡<code>trapBubbledEvent()</code>为例来描述处理流程，可以看到其调用了<code>trapEventForPluginEventSystem</code>方法。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\react-dom\src\events\ReactDOMEventListener.js line 203</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trapBubbledEvent</span><span class="token punctuation">(</span>
  <span class="token parameter">topLevelType<span class="token operator">:</span> DOMTopLevelEventType<span class="token punctuation">,</span>
  element<span class="token operator">:</span> Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token function">trapEventForPluginEventSystem</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> topLevelType<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>可以看到<code>React</code>将事件分成了三类，优先级由低到高：</p> <ul><li><code>DiscreteEvent</code>离散事件，例如<code>blur</code>、<code>focus</code>、 <code>click</code>、 <code>submit</code>、 <code>touchStart</code>，这些事件都是离散触发的。</li> <li><code>UserBlockingEvent</code>用户阻塞事件，例如<code>touchMove</code>、<code>mouseMove</code>、<code>scroll</code>、<code>drag</code>、<code>dragOver</code>等等，这些事件会阻塞用户的交互。</li> <li><code>ContinuousEvent</code>连续事件，例如<code>load</code>、<code>error</code>、<code>loadStart</code>、<code>abort</code>、<code>animationEnd</code>，这个优先级最高，也就是说它们应该是立即同步执行的，这就是<code>Continuous</code>的意义，是持续地执行，不能被打断。</li></ul> <p>此外<code>React</code>将事件系统用到了<code>Fiber</code>架构里，<code>Fiber</code>中将任务分成了<code>5</code>大类，对应不同的优先级，那么三大类的事件系统和五大类的<code>Fiber</code>任务系统的对应关系如下。</p> <ul><li><code>Immediate</code>: 此类任务会同步执行，或者说马上执行且不能中断，<code>ContinuousEvent</code>便属于此类。</li> <li><code>UserBlocking</code>: 此类任务一般是用户交互的结果，需要及时得到反馈，<code>DiscreteEvent</code>与<code>UserBlockingEvent</code>都属于此类。</li> <li><code>Normal</code>: 此类任务是应对那些不需要立即感受到反馈的任务，比如网络请求。</li> <li><code>Low</code>: 此类任务可以延后处理，但最终应该得到执行，例如分析通知。</li> <li><code>Idle</code>: 此类任务的定义为没有必要做的任务。</li></ul> <p>回到<code>trapEventForPluginEventSystem</code>，实际上在这三类事件，他们最终都会有统一的触发函数<code>dispatchEvent</code>，只不过在<code>dispatch</code>之前会需要进行一些特殊的处理。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\react-dom\src\events\ReactDOMEventListener.js line 256</span>
<span class="token keyword">function</span> <span class="token function">trapEventForPluginEventSystem</span><span class="token punctuation">(</span>
  <span class="token parameter">element<span class="token operator">:</span> Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span>
  topLevelType<span class="token operator">:</span> DOMTopLevelEventType<span class="token punctuation">,</span>
  capture<span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> listener<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getEventPriority</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> DiscreteEvent<span class="token operator">:</span>
      listener <span class="token operator">=</span> <span class="token function">dispatchDiscreteEvent</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        topLevelType<span class="token punctuation">,</span>
        <span class="token constant">PLUGIN_EVENT_SYSTEM</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> UserBlockingEvent<span class="token operator">:</span>
      listener <span class="token operator">=</span> <span class="token function">dispatchUserBlockingUpdate</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>
        <span class="token keyword">null</span><span class="token punctuation">,</span>
        topLevelType<span class="token punctuation">,</span>
        <span class="token constant">PLUGIN_EVENT_SYSTEM</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> ContinuousEvent<span class="token operator">:</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token comment">// 统一的分发函数 dispatchEvent</span>
      listener <span class="token operator">=</span> <span class="token function">dispatchEvent</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> topLevelType<span class="token punctuation">,</span> <span class="token constant">PLUGIN_EVENT_SYSTEM</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> rawEventName <span class="token operator">=</span> <span class="token function">getRawEventName</span><span class="token punctuation">(</span>topLevelType<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>capture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册捕获事件</span>
    <span class="token function">addEventCaptureListener</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> rawEventName<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册冒泡事件</span>
    <span class="token function">addEventBubbleListener</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> rawEventName<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>到达最终的事件注册，实际上就是在<code>document</code>上注册了各种事件。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\react-dom\src\events\EventListener.js line 10</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addEventBubbleListener</span><span class="token punctuation">(</span>
  <span class="token parameter">element<span class="token operator">:</span> Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span>
  eventType<span class="token operator">:</span> string<span class="token punctuation">,</span>
  listener<span class="token operator">:</span> Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addEventCaptureListener</span><span class="token punctuation">(</span>
  <span class="token parameter">element<span class="token operator">:</span> Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span>
  eventType<span class="token operator">:</span> string<span class="token punctuation">,</span>
  listener<span class="token operator">:</span> Function<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">addEventCaptureListenerWithPassiveFlag</span><span class="token punctuation">(</span>
  <span class="token parameter">element<span class="token operator">:</span> Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span>
  eventType<span class="token operator">:</span> string<span class="token punctuation">,</span>
  listener<span class="token operator">:</span> Function<span class="token punctuation">,</span>
  passive<span class="token operator">:</span> boolean<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  element<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventType<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    capture<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    passive<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="事件存储"><a href="#事件存储" class="header-anchor">#</a> 事件存储</h3> <p>让我们回到上边的<code>listenToTopLevel</code>方法中的<code>listeningSet.add(topLevelType)</code>，即是将事件添加到注册到事件列表对象中，即将<code>DOM</code>节点和对应的事件保存到<code>Weak Map</code>对象中，具体来说就是<code>DOM</code>节点作为键名，事件对象的<code>Set</code>作为键值，这里的数据集合有自己的名字叫做<code>EventPluginHub</code>，当然在这里最理想的情况会是使用<code>WeakMap</code>进行存储，不支持则使用<code>Map</code>对象，使用<code>WeakMap</code>主要是考虑到<code>WeakMaps</code>保持了对键名所引用的对象的弱引用，不用担心内存泄漏问题，<code>WeakMaps</code>应用的典型场合就是<code>DOM</code>节点作为键名。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\react-dom\src\events\ReactBrowserEventEmitter.js line 88</span>
<span class="token keyword">const</span> PossiblyWeakMap <span class="token operator">=</span> <span class="token keyword">typeof</span> WeakMap <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> WeakMap <span class="token operator">:</span> Map<span class="token punctuation">;</span>
<span class="token keyword">const</span> elementListeningSets<span class="token operator">:</span>
  <span class="token operator">|</span> WeakMap
  <span class="token operator">|</span> Map<span class="token operator">&lt;</span>
      Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span>
      Set<span class="token operator">&lt;</span>DOMTopLevelEventType <span class="token operator">|</span> string<span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PossiblyWeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">getListeningSetForElement</span><span class="token punctuation">(</span>
  <span class="token parameter">element<span class="token operator">:</span> Document <span class="token operator">|</span> Element <span class="token operator">|</span> Node<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>DOMTopLevelEventType <span class="token operator">|</span> string<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> listeningSet <span class="token operator">=</span> elementListeningSets<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>listeningSet <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listeningSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    elementListeningSets<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span> listeningSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> listeningSet<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="事件合成"><a href="#事件合成" class="header-anchor">#</a> 事件合成</h3> <p>首先来看看<code>handleTopLevel</code>的逻辑，<code>handleTopLevel</code>主要是缓存祖先元素，避免事件触发后找不到祖先元素报错，接下来就进入<code>runExtractedPluginEventsInBatch</code>方法。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\react-dom\src\events\ReactDOMEventListener.js line 151</span>
<span class="token keyword">function</span> <span class="token function">handleTopLevel</span><span class="token punctuation">(</span><span class="token parameter">bookKeeping<span class="token operator">:</span> BookKeepingInstance</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> targetInst <span class="token operator">=</span> bookKeeping<span class="token punctuation">.</span>targetInst<span class="token punctuation">;</span>

  <span class="token comment">// Loop through the hierarchy, in case there's any nested components.</span>
  <span class="token comment">// It's important that we build the array of ancestors before calling any</span>
  <span class="token comment">// event handlers, because event handlers can modify the DOM, leading to</span>
  <span class="token comment">// inconsistencies with ReactMount's node cache. See #1105.</span>
  <span class="token keyword">let</span> ancestor <span class="token operator">=</span> targetInst<span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ancestor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ancestors <span class="token operator">=</span> bookKeeping<span class="token punctuation">.</span>ancestors<span class="token punctuation">;</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>ancestors<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> root <span class="token operator">=</span> <span class="token function">findRootContainerNode</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> tag <span class="token operator">=</span> ancestor<span class="token punctuation">.</span>tag<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      bookKeeping<span class="token punctuation">.</span>ancestors<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ancestor <span class="token operator">=</span> <span class="token function">getClosestInstanceFromNode</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ancestor<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bookKeeping<span class="token punctuation">.</span>ancestors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    targetInst <span class="token operator">=</span> bookKeeping<span class="token punctuation">.</span>ancestors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> eventTarget <span class="token operator">=</span> <span class="token function">getEventTarget</span><span class="token punctuation">(</span>bookKeeping<span class="token punctuation">.</span>nativeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> topLevelType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bookKeeping<span class="token punctuation">.</span>topLevelType<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> DOMTopLevelEventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nativeEvent <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bookKeeping<span class="token punctuation">.</span>nativeEvent<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> AnyNativeEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">runExtractedPluginEventsInBatch</span><span class="token punctuation">(</span>
      topLevelType<span class="token punctuation">,</span>
      targetInst<span class="token punctuation">,</span>
      nativeEvent<span class="token punctuation">,</span>
      eventTarget<span class="token punctuation">,</span>
      bookKeeping<span class="token punctuation">.</span>eventSystemFlags<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>在<code>runExtractedPluginEventsInBatch</code>中<code>extractPluginEvents</code>用于通过不同的插件合成事件<code>events</code>，而<code>runEventsInBatch</code>则是完成事件的触发。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\legacy-events\EventPluginHub.js line 160</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">runExtractedPluginEventsInBatch</span><span class="token punctuation">(</span>
  <span class="token parameter">topLevelType<span class="token operator">:</span> TopLevelType<span class="token punctuation">,</span>
  targetInst<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Fiber<span class="token punctuation">,</span>
  nativeEvent<span class="token operator">:</span> AnyNativeEvent<span class="token punctuation">,</span>
  nativeEventTarget<span class="token operator">:</span> EventTarget<span class="token punctuation">,</span>
  eventSystemFlags<span class="token operator">:</span> EventSystemFlags<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token function">extractPluginEvents</span><span class="token punctuation">(</span>
    topLevelType<span class="token punctuation">,</span>
    targetInst<span class="token punctuation">,</span>
    nativeEvent<span class="token punctuation">,</span>
    nativeEventTarget<span class="token punctuation">,</span>
    eventSystemFlags<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">runEventsInBatch</span><span class="token punctuation">(</span>events<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>在<code>extractPluginEvents</code>中遍历所有插件的<code>extractEvents</code>方法合成事件，如果这个插件适合于这个<code>events</code>则返回它，否则返回<code>null</code>。默认的有<code>5</code>种插件<code>SimpleEventPlugin</code>、<code>EnterLeaveEventPlugin</code>、<code>ChangeEventPlugin</code>、<code>SelectEventPlugin</code>、<code>BeforeInputEventPlugin</code>。2</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\legacy-events\EventPluginHub.js line 133</span>
<span class="token keyword">function</span> <span class="token function">extractPluginEvents</span><span class="token punctuation">(</span>
  <span class="token parameter">topLevelType<span class="token operator">:</span> TopLevelType<span class="token punctuation">,</span>
  targetInst<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> Fiber<span class="token punctuation">,</span>
  nativeEvent<span class="token operator">:</span> AnyNativeEvent<span class="token punctuation">,</span>
  nativeEventTarget<span class="token operator">:</span> EventTarget<span class="token punctuation">,</span>
  eventSystemFlags<span class="token operator">:</span> EventSystemFlags<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>ReactSyntheticEvent<span class="token operator">&gt;</span> <span class="token operator">|</span> ReactSyntheticEvent <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> events <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> plugins<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Not every plugin in the ordering may be loaded at runtime.</span>
    <span class="token keyword">const</span> possiblePlugin<span class="token operator">:</span> PluginModule<span class="token operator">&lt;</span>AnyNativeEvent<span class="token operator">&gt;</span> <span class="token operator">=</span> plugins<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>possiblePlugin<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> extractedEvents <span class="token operator">=</span> possiblePlugin<span class="token punctuation">.</span><span class="token function">extractEvents</span><span class="token punctuation">(</span>
        topLevelType<span class="token punctuation">,</span>
        targetInst<span class="token punctuation">,</span>
        nativeEvent<span class="token punctuation">,</span>
        nativeEventTarget<span class="token punctuation">,</span>
        eventSystemFlags<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>extractedEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        events <span class="token operator">=</span> <span class="token function">accumulateInto</span><span class="token punctuation">(</span>events<span class="token punctuation">,</span> extractedEvents<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> events<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>不同的事件类型会有不同的合成事件基类，然后再通过<code>EventConstructor.getPooled</code>生成事件，<code>accumulateTwoPhaseDispatches</code>用于获取事件回调函数，最终调的是<code>getListener</code>方法。
为了避免频繁创建和释放事件对象导致性能损耗(对象创建和垃圾回收)，<code>React</code>使用一个事件池来负责管理事件对象(在<code>React17</code>中不再使用事件池机制)，使用完的事件对象会放回池中，以备后续的复用，也就意味着事件处理器同步执行完后，<code>SyntheticEvent</code>属性就会马上被回收，不能访问了，也就是事件中的<code>e</code>不能用了，如果要用的话，可以通过一下两种方式：</p> <ul><li>使用<code>e.persist()</code>，告诉<code>React</code>不要回收对象池，在<code>React17</code>依旧可以调用只是没有实际作用。</li> <li>使用<code>e. nativeEvent</code>，因为它是持久引用的。</li></ul> <h3 id="事件分发"><a href="#事件分发" class="header-anchor">#</a> 事件分发</h3> <p>事件分发就是遍历找到当前元素及父元素所有绑定的事件，将所有的事件放到<code>event._dispachListeners</code>队列中，以备后续的执行。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\legacy-events\EventPropagators.js line 47</span>
<span class="token keyword">function</span> <span class="token function">accumulateDirectionalDispatches</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> phase<span class="token punctuation">,</span> event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">warningWithoutStack</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> <span class="token string">'Dispatching inst must not be null'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> listener <span class="token operator">=</span> <span class="token function">listenerAtPhase</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> event<span class="token punctuation">,</span> phase<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>listener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将提取到的绑定添加到_dispatchListeners中</span>
    event<span class="token punctuation">.</span>_dispatchListeners <span class="token operator">=</span> <span class="token function">accumulateInto</span><span class="token punctuation">(</span>
      event<span class="token punctuation">.</span>_dispatchListeners<span class="token punctuation">,</span>
      listener<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>_dispatchInstances <span class="token operator">=</span> <span class="token function">accumulateInto</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>_dispatchInstances<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="事件执行"><a href="#事件执行" class="header-anchor">#</a> 事件执行</h3> <p>执行事件队列用到的方法是<code>runEventsInBatch</code>，遍历执行<code>executeDispatchesInOrder</code>方法，通过<code>executeDispatch</code>执行调度，最终执行回调函数是通过<code>invokeGuardedCallbackAndCatchFirstError</code>方法。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// packages\legacy-events\EventBatching.js line 42</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">runEventsInBatch</span><span class="token punctuation">(</span>
  <span class="token parameter">events<span class="token operator">:</span> Array<span class="token operator">&lt;</span>ReactSyntheticEvent<span class="token operator">&gt;</span> <span class="token operator">|</span> ReactSyntheticEvent <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>events <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eventQueue <span class="token operator">=</span> <span class="token function">accumulateInto</span><span class="token punctuation">(</span>eventQueue<span class="token punctuation">,</span> events<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Set `eventQueue` to null before processing it so that we can tell if more</span>
  <span class="token comment">// events get enqueued while processing.</span>
  <span class="token keyword">const</span> processingEventQueue <span class="token operator">=</span> eventQueue<span class="token punctuation">;</span>
  eventQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>processingEventQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">forEachAccumulated</span><span class="token punctuation">(</span>processingEventQueue<span class="token punctuation">,</span> executeDispatchesAndReleaseTopLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">invariant</span><span class="token punctuation">(</span>
    <span class="token operator">!</span>eventQueue<span class="token punctuation">,</span>
    <span class="token string">'processEventQueue(): Additional events were enqueued while processing '</span> <span class="token operator">+</span>
      <span class="token string">'an event queue. Support for this has not yet been implemented.'</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// This would be a good time to rethrow if any of the event handlers threw.</span>
  <span class="token function">rethrowCaughtError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// packages\legacy-events\EventPluginUtils.js line 76</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">executeDispatchesInOrder</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatchListeners <span class="token operator">=</span> event<span class="token punctuation">.</span>_dispatchListeners<span class="token punctuation">;</span>
  <span class="token keyword">const</span> dispatchInstances <span class="token operator">=</span> event<span class="token punctuation">.</span>_dispatchInstances<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__DEV__<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">validateEventDispatches</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>dispatchListeners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dispatchListeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">isPropagationStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Listeners and Instances are two parallel arrays that are always in sync.</span>
      <span class="token function">executeDispatch</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> dispatchListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> dispatchInstances<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dispatchListeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">executeDispatch</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> dispatchListeners<span class="token punctuation">,</span> dispatchInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  event<span class="token punctuation">.</span>_dispatchListeners <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span>_dispatchInstances <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// packages\legacy-events\EventPluginUtils.js line 66</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">executeDispatch</span><span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> inst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> event<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token string">'unknown-event'</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span>currentTarget <span class="token operator">=</span> <span class="token function">getNodeFromInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">invokeGuardedCallbackAndCatchFirstError</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
  event<span class="token punctuation">.</span>currentTarget <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// packages\shared\ReactErrorUtils.js line 67</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> invokeGuardedCallbackAndCatchFirstError<span class="token operator">&lt;</span>
  <span class="token constant">A</span><span class="token punctuation">,</span>
  <span class="token constant">B</span><span class="token punctuation">,</span>
  <span class="token constant">C</span><span class="token punctuation">,</span>
  <span class="token constant">D</span><span class="token punctuation">,</span>
  <span class="token constant">E</span><span class="token punctuation">,</span>
  <span class="token constant">F</span><span class="token punctuation">,</span>
  Context<span class="token punctuation">,</span>
<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  name<span class="token operator">:</span> string <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token function-variable function">func</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">,</span> b<span class="token operator">:</span> <span class="token constant">B</span><span class="token punctuation">,</span> c<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">,</span> d<span class="token operator">:</span> <span class="token constant">D</span><span class="token punctuation">,</span> e<span class="token operator">:</span> <span class="token constant">E</span><span class="token punctuation">,</span> f<span class="token operator">:</span> <span class="token constant">F</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span>
  context<span class="token operator">:</span> Context<span class="token punctuation">,</span>
  a<span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">,</span>
  b<span class="token operator">:</span> <span class="token constant">B</span><span class="token punctuation">,</span>
  c<span class="token operator">:</span> <span class="token constant">C</span><span class="token punctuation">,</span>
  d<span class="token operator">:</span> <span class="token constant">D</span><span class="token punctuation">,</span>
  e<span class="token operator">:</span> <span class="token constant">E</span><span class="token punctuation">,</span>
  f<span class="token operator">:</span> <span class="token constant">F</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token function">invokeGuardedCallback</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hasError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token function">clearCaughtError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasRethrowError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hasRethrowError <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      rethrowError <span class="token operator">=</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><h2 id=""><a href="#" class="header-anchor">#</a></h2> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p>https://zhuanlan.zhihu.com/p/53961511
https://zhuanlan.zhihu.com/p/25883536
https://zhuanlan.zhihu.com/p/140791931
https://www.jianshu.com/p/8d8f9aa4b033
https://toutiao.io/posts/28of14w/preview
https://juejin.cn/post/6844903988794671117
https://segmentfault.com/a/1190000015142568
https://zh-hans.reactjs.org/docs/events.html
https://github.com/UNDERCOVERj/tech-blog/issues/13
https://blog.csdn.net/kyooo0/article/details/111829693</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">6/23/2021, 8:45:49 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learn-blog/dist/note/Node/PM2工作机制.html" class="prev">
        PM2工作机制
      </a></span> <span class="next"><a href="/learn-blog/dist/note/React/手写redux.html">
        手写Redux
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><section class="side-anchor"><ul style="display:none;"></ul></section></div></div>
    <script src="/learn-blog/dist/assets/js/app.32413baa.js" defer></script><script src="/learn-blog/dist/assets/js/2.0abb358e.js" defer></script><script src="/learn-blog/dist/assets/js/81.740caffe.js" defer></script>
  </body>
</html>

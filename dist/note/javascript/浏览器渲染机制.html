<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>浏览器工作原理 | BINGO BLOG</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/learn-blog/dist/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
    <meta name="description" content="BINGO BLOG 学然后知不足 非淡泊无以明志，非宁静无以致远">
    <meta name="keywords" content="博客，前端，代码，个人博客，学习，兴趣，BINGOBLOG">
    
    <link rel="preload" href="/learn-blog/dist/assets/css/0.styles.4b1e8fc9.css" as="style"><link rel="preload" href="/learn-blog/dist/assets/js/app.47b52d01.js" as="script"><link rel="preload" href="/learn-blog/dist/assets/js/2.9615dc11.js" as="script"><link rel="preload" href="/learn-blog/dist/assets/js/3.74cb7266.js" as="script"><link rel="prefetch" href="/learn-blog/dist/assets/js/10.fee66f5e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/11.bb11362d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/12.091ef70a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/13.1322aae2.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/14.0cba4e5e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/15.793bd97a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/16.3a5f59bb.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/17.2da1d357.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/18.0e13a599.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/19.9d2bd949.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/20.1897b020.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/21.cedcbaa2.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/22.d944ca7e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/23.52428397.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/24.856765a8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/25.c6df9714.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/26.4e7b62da.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/27.f32b3f6b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/28.3ef7e612.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/29.22113ff4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/30.4045b06f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/31.8d00d40c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/32.6f89db35.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/33.9282d757.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/34.f3174724.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/35.3463c572.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/36.e0f19ebe.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/37.d6bc54a8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/38.6005ad2e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/39.61965404.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/4.5da2aed6.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/40.c693a727.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/41.36030a88.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/42.8e62f3cc.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/43.8cf4416b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/44.a7c2a2f3.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/45.010cdc4c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/46.f6dd44ce.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/47.592d1c79.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/48.77790547.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/49.930654fd.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/5.f2f4abf5.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/50.00cbb1a7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/51.b146a658.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/52.471a97b4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/53.c96393b4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/54.44209354.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/55.8578b003.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/56.773a7161.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/57.f4b76cad.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/58.7f183d5b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/59.55f64c91.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/6.8b279cc8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/60.ac86f15d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/61.20bf2208.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/62.ba039020.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/63.4b48631b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/64.05fd7730.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/65.cba67421.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/66.c52d59cb.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/67.49090420.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/68.c8c77d51.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/69.cfc23bfa.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/7.da7d15f7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/70.de51e2ce.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/71.ee88707f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/72.21197ef7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/73.556deedb.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/74.f5381499.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/75.ff8fbe7f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/76.2d4e5564.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/77.165a2061.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/78.96ba1617.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/79.b6ab4d41.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/8.960eb72c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/80.49f7142c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/81.91f76553.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/82.59382fa9.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/83.6d327eaa.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/84.36b7afe9.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/9.1b4e1c73.js">
    <link rel="stylesheet" href="/learn-blog/dist/assets/css/0.styles.4b1e8fc9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-blog/dist/" class="home-link router-link-active"><img src="/learn-blog/dist/logo.png" alt="BINGO BLOG" class="logo"> <span class="site-name can-hide">BINGO BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/learn-blog/dist/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/learn-blog/dist/algorithm/" class="nav-link">
  算法
</a></div> <a href="https://github.com/bingoYB/learn-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/learn-blog/dist/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/learn-blog/dist/algorithm/" class="nav-link">
  算法
</a></div> <a href="https://github.com/bingoYB/learn-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程思想</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-blog/dist/note/javascript/JS执行上下文.html" class="sidebar-link">JS执行上下文</a></li><li><a href="/learn-blog/dist/note/javascript/WebWorker.html" class="sidebar-link">Web Worker</a></li><li><a href="/learn-blog/dist/note/javascript/Workbox.html" class="sidebar-link">PWA之Workbox缓存策略分析</a></li><li><a href="/learn-blog/dist/note/javascript/serviceworker.html" class="sidebar-link">Service Worker</a></li><li><a href="/learn-blog/dist/note/javascript/垃圾回收技术.html" class="sidebar-link">垃圾回收技术</a></li><li><a href="/learn-blog/dist/note/javascript/垃圾回收机制.html" class="sidebar-link">垃圾回收机制</a></li><li><a href="/learn-blog/dist/note/javascript/浏览器渲染机制.html" class="active sidebar-link">浏览器工作原理</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端图形学</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="浏览器工作原理"><a href="#浏览器工作原理" class="header-anchor">#</a> 浏览器工作原理</h1> <h3 id="浏览器结构"><a href="#浏览器结构" class="header-anchor">#</a> 浏览器结构</h3> <p><img src="/learn-blog/dist/assets/img/browser_structure8.70f6e1ea.png" alt="browser_structure"></p> <ul><li>用户界面（User Interface）</li> <li>浏览器引擎（Browser Engine）</li> <li>渲染引擎（Rendering Engine）</li> <li>网络（Networking）</li> <li>XML解析器（XML Parser）</li> <li>显示后端（Display Backend）</li> <li>数据持久层（Data Persistence）</li></ul> <h3 id="常见渲染引擎"><a href="#常见渲染引擎" class="header-anchor">#</a> 常见渲染引擎</h3> <p>渲染引擎：能够能够将HTML/CSS/JavaScript文本及相应的资源文件转换成图像结果</p> <p>渲染引擎的种类</p> <table><thead><tr><th>渲染引擎</th> <th>浏览器</th></tr></thead> <tbody><tr><td>Trident</td> <td>IE、Edge(旧)</td></tr> <tr><td>Gecko</td> <td>Firefox</td></tr> <tr><td>WebKit</td> <td>Safari</td></tr> <tr><td>Blink(WebKit fork)</td> <td>Chromium/Chrome，Opera，Edge(新)</td></tr></tbody></table> <h3 id="工作流程"><a href="#工作流程" class="header-anchor">#</a> 工作流程</h3> <p>简单流程</p> <p><img src="/learn-blog/dist/assets/img/browser_simple_workflow-2d0e702b575f29ec96473c91d08862b7.b03ab827.png" alt="browser_simple_workflow"></p> <p>详细流程</p> <p><img src="/learn-blog/dist/assets/img/browser_workflow-08efb76c5a48fde5f0c40f3ff72624f1.5bfd3830.png" alt="browser_workflow"></p> <h3 id="浏览器的多进程架构"><a href="#浏览器的多进程架构" class="header-anchor">#</a> 浏览器的多进程架构</h3> <p><img src="/learn-blog/dist/assets/img/chrome_architecture-ffd69b40c3fc0372925b451d97c4ddac.77ee2836.png" alt="chrome_architecture"></p> <p>Browser：控制程序的“chrome”部分，包括地址栏，书签，后退和前进按钮。还处理Web浏览器的不可见的，和特权部分，例如网络请求和文件访问</p> <p>Renderer：负责显示网站的选项卡内的所有内容</p> <p>Plugin：控制网站使用的所有插件，例如flash</p> <p>GPU：独立于其他进程的GPU处理任务。 它被分成多个不同的进程，因为GPU处理来自多个程序的请求并将它们绘制在同一个面中</p> <h3 id="渲染进程"><a href="#渲染进程" class="header-anchor">#</a> 渲染进程</h3> <p>渲染器进程负责选项卡内发生的所有事情。 在渲染器进程中，主线程处理你为用户编写的大部分代码</p> <p>如果你使用了web worker 或 service worker，有时JavaScript代码的一部分将由工作线程处理。 排版和栅格线程也在渲染器进程内运行，以便高效、流畅地呈现页面</p> <p><img src="/learn-blog/dist/assets/img/chrome_renderer_prscess-1d9b9a1bb9d1743b4506e67f73e99f49.929e80d4.png" alt="chrome_renderer_prscess"></p> <h4 id="渲染过程-解析部分"><a href="#渲染过程-解析部分" class="header-anchor">#</a> 渲染过程 ：解析部分</h4> <p><img src="/learn-blog/dist/assets/img/v2-71ef343b6a7b8ad7cf8aebbda44e77fd_720w.e0924b6b.jpg" alt="img"></p> <h5 id="html解析"><a href="#html解析" class="header-anchor">#</a> html解析</h5> <p>第一步（解析）：从网络或者磁盘下读取的HTML原始字节码，通过设置的charset编码，转换成相字符</p> <p><img src="/learn-blog/dist/assets/img/v2-36ed368865ab9363706d57c66058b697_720w.0cc986eb.jpg" alt="img"></p> <p>第二步（token化）：通过词法分析器，将字符串解析成Token，Token中会标注出当前的Token是<code>开始标签</code>，还是<code>结束标签</code>，或者<code>文本标签</code>等。</p> <p><img src="/learn-blog/dist/assets/img/v2-ccaacbf35961ff61f30be90ac5b1be10_720w.eccd3a0f.jpg" alt="img"></p> <p>第三步（生成Nodes并构建DOM树）：浏览器会根据Tokens里记录的<code>开始标签</code>，<code>结束标签</code>，将Tokens之间相互串联起来*（带有结束标签的Token不会生成Node）*。</p> <blockquote><p>Token：<strong>标记</strong>，词法分析是计算机科学中将字符序列转换为<strong>标记</strong>（token）序列的过程。从输入字符流中生成标记的过程叫作<strong>标记化</strong>（tokenization），在这个过程中，<a href="https://baike.baidu.com/item/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%99%A8/4336210" target="_blank" rel="noopener noreferrer">词法分析器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>还会对标记进行分类。</p></blockquote> <p>Node包含了这个节点的所有属性。例如<code>&lt;img src=&quot;xxx.png&quot; &gt;</code>标签最终生成出的节点对象中会保存图片地址等信息。
事实上，在构建DOM树时，不是要等所有的Tokens都转换成Nodes后才开始，而是一边生成Token一边采取<code>深度遍历算法</code>消耗Token来生成Node，如下图所示：</p> <p>图中有颜色的小数字代表构建的具体步骤，可以看出，首先生成出<code>html Token</code>,并消耗Token创建出<code>html 节点对象</code>，接着生成<code>head Token</code>并消耗Token创建出<code>head节点对象</code>......，当所有的Tokens都消耗完了，紧接着DOM树也就构建完了。</p> <p><img src="/learn-blog/dist/assets/img/v2-390e7945e6d578f61a96aadd14837c60_720w.aea2f1e8.jpg" alt="img"></p> <blockquote><p><em>1.词法分析是将字符流(char stream)转换为记号流(token stream)</em></p> <p><em>2.语法分析成 AST (Abstract Syntax Tree) 在HTML中就构建DOM节点，生成DOM树</em></p></blockquote> <h5 id="子资源加载"><a href="#子资源加载" class="header-anchor">#</a> 子资源加载</h5> <blockquote><p>注意JavaScript可以阻止解析</p></blockquote> <p>在构建DOM树中遇到css资源、图片、script脚本资源时进行网络加载</p> <h5 id="css解析-样式表计算"><a href="#css解析-样式表计算" class="header-anchor">#</a> css解析，样式表计算</h5> <p>DOM会记录页面的内容，但是浏览器还需要知道这些内容该用什么样式去展示，所以还需要构建CSSOMTree。CSSOM的生成过程和DOM的生成过程十分相似，也是：1.解析，2.Token化，3.生成Nodes并构建CSSOMTree：</p> <p>假设浏览器收到了下面这样一段css:</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">body</span> <span class="token punctuation">{</span><span class="token property">font-size</span><span class="token punctuation">:</span> 16px<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">p</span> <span class="token punctuation">{</span><span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">p span</span> <span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span>none<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">span</span> <span class="token punctuation">{</span><span class="token property">color</span><span class="token punctuation">:</span> red<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token selector">img</span> <span class="token punctuation">{</span><span class="token property">float</span><span class="token punctuation">:</span> right<span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>最终会生成如下的CSSOMTree:</p> <p><img src="/learn-blog/dist/assets/img/v2-f256433f72ea22db26e4baa02cecac19_r.00e82292.jpg" alt="preview"></p> <p>官方对CSSOM构建给的一种解释：</p> <blockquote><p>未构建完的CSSOMTree是不准确的，浏览器必须等到CSSOMTree构建完毕后才能进入下一阶段。
所以，CSS的加载速度与构建CSSOMTree的速度将直接影响首屏渲染速度，因此在默认情况下CSS被视为阻塞渲染的资源，需要将它尽早、尽快地下载到客户端，以便缩短首次渲染的时间。</p></blockquote> <p>同理，JS也会可以修改CSS样式，影响CSSOMTree最终的结果。而我们前面提到，不完整的CSSOMTree是不可以被使用的，如果JS试图在<strong>浏览器还未完成CSSOMTree的下载和构建</strong>时去操作CSS样式，浏览器会<strong>暂停脚本的运行和DOM的构建</strong>，直至浏览器完成了CSSOM的下载和构建。也就是说，<strong>JS脚本的出现会让CSSOM的构建阻塞DOM的构建</strong>。</p> <blockquote><p>平时谈及页面性能优化，经常会强调css文件应该放在html文档中的前面引入，js文件应该放在后面引入，这么做的原因是什么呢？</p></blockquote> <p>如果JS放在前面，那么js执行时间与css执行时间会阻塞DOM树的构建</p> <p><img src="/learn-blog/dist/assets/img/v2-0e9c2c1761f084689a984a86866fc85d_720w.a1ba9e7f.jpg" alt="img"></p> <p>那如果我们把css放到前面，js放到最后引入时，构建时间会变成：</p> <p><img src="/learn-blog/dist/assets/img/v2-2fd68d4d3e0fff48d8a27d1ad72c7d65_720w.b1cb1863.jpg" alt="img"></p> <h5 id="布局-渲染-布局树构建"><a href="#布局-渲染-布局树构建" class="header-anchor">#</a> 布局：渲染/布局树构建</h5> <p>DOM/CSSOM树本身并不能直接用于排版和渲染，浏览器还会生成另外一棵树：Render树。</p> <p>将CSSOM应用到DOM树中每一个元素上，形成RenderTree</p> <p><img src="/learn-blog/dist/assets/img/render-tree-construction.0c389301.png" alt="将 DOM 与 CSSOM 合并以形成渲染树"></p> <ul><li><p>Render 树上的每一个节点被称为：<code>RenderObject</code>。</p></li> <li><p>RenderObject跟 DOM 节点几乎是一一对应的，当一个<code>可见的 DOM 节点</code>被添加到 DOM 树上时，内核就会为它生成对应的 RenderOject 添加到 Render 树上。</p></li> <li><p>其中，可见的DOM节点不包括：</p> <ul><li>一些不会体现在渲染输出中的节点（<code>&lt;html&gt;&lt;script&gt;&lt;link&gt;….</code>），会直接被忽略掉。</li> <li>通过CSS隐藏的节点。例如上图中的<code>span</code>节点，因为有一个CSS显式规则在该节点上设置了<code>display:none</code>属性，那么它在生成RenderObject时会被直接忽略掉。</li></ul></li></ul> <h5 id="分层-layer图层树"><a href="#分层-layer图层树" class="header-anchor">#</a> 分层：Layer图层树</h5> <blockquote><p>浏览器渲染引擎并不是直接使用Render树进行绘制，为了方便处理<strong>Positioning,Clipping,Overflow-scroll,CSS Transfrom/Opacrity/Animation/Filter,Mask or Reflection,Z-index</strong>等属性，浏览器需要生成另外一棵树：<strong>Layer树 （ 层级树）</strong></p></blockquote> <p>RenderLayer树是基于Render树建立起来的一颗新的树。同样，RenderLayer节点和Render节点不是一一对应关系，而是一对多的关系。</p> <p>浏览器会为一些<strong>特定</strong>的<code>RenderObject</code>生成对应的<code>RenderLayer</code>，其中的规则是：</p> <ul><li>是否是页面的根节点 document节点与html节点 <em>It’s the root object for the page</em></li> <li>是否有css的一些布局属性（relative absolute or a transform) <em>It has explicit CSS position properties (relative, absolute or a transform)</em></li> <li>是否透明 <em>It is transparent</em></li> <li>是否有溢出 <em>Has overflow, an alpha mask or reflection</em></li> <li>是否有css滤镜 <em>Has a CSS filter</em></li> <li>是否包含一个canvas元素使得节点拥有视图上下文 <em>Corresponds to canvas element that has a 3D (WebGL) context or an accelerated 2D context</em></li> <li>是否包含一个video元素 <em>Corresponds to a video element</em></li></ul> <p>为了直观了解这三种树，下图给出了这三种树及其它们之间的对应关系。</p> <img src="/learn-blog/dist/assets/img/2014_05_04_02.2b170338.gif" alt="img" style="zoom:150%;"> <h5 id="paint-绘制"><a href="#paint-绘制" class="header-anchor">#</a> Paint 绘制</h5> <p>在绘制阶段，主线程会遍历布局树（layout tree），生成一系列的绘画记录（paint records）。并将其提交到合成线程。</p> <p><img src="/learn-blog/dist/assets/img/bro5.09d8c607.png" alt="image-20210322163500605"></p> <h4 id="渲染过程-合成部分"><a href="#渲染过程-合成部分" class="header-anchor">#</a> 渲染过程：合成部分</h4> <h5 id="分块、光栅化"><a href="#分块、光栅化" class="header-anchor">#</a> 分块、光栅化</h5> <p>**光栅化：**把文档的结构、元素的样式、几何 形状和绘制顺序转换为屏幕上的像素称为光栅化，这个操作会提交到GPU进程进行工作</p> <p><strong>合成</strong>是一种将页面的各个部分分层，分别栅格化，并在一个被称为合成器线程的独立线程中合成为页面的技术。</p> <p>合成线程会根据视口viewport将图层(Layer) 切分为一块又一块的小图块（tiles），之后将这些小图块分别进行发送给一系列光栅线程（raster threads）进行光栅化，结束后光栅线程会将每个图块的光栅结果存在<code>GPU Process</code>的内存中。</p> <p>为了优化显示体验，合成线程可以给不同的光栅线程赋予不同的优先级，将那些在视口中的或者视口附近的层先被光栅化。</p> <h5 id="合成与显示"><a href="#合成与显示" class="header-anchor">#</a> 合成与显示</h5> <p>⼀旦所有图块都被光栅化， 合成线程就会⽣成⼀个绘制图块的命令⸺“DrawQuad” ， 然后将该命令通过IPC提交给浏览器进程。 浏览器进程⾥⾯有⼀个叫 viz 的组件， ⽤来接收合成线程发过来的 DrawQuad 命 令， 然后根据 DrawQuad 命令， 将其⻚⾯内容绘制到内存中， 最后再将内存显⽰在屏幕上。</p> <p><img src="/learn-blog/dist/assets/img/bro4.cfd98577.png" alt="image-20210322162906930"></p> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <p>渲染主线程</p> <ol><li>渲染进程将 HTML 内容转换为能够读懂的 DOM 树结构。</li> <li>渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets， 计算出 DOM 节点的样式。</li> <li>创建布局树， 并计算元素的布局信息。</li> <li>对布局树进⾏分层， 并⽣成分层树。</li> <li>绘制（Paint）：为每个图层⽣成绘制列表， 并将其提交到合成线程。</li></ol> <p>合成线程</p> <ol><li>合成线程将图层分成图块， 并在光栅化线程池中将图块转换成位图。</li> <li>合成线程发送绘制图块命令 DrawQuad 给浏览器进程。</li> <li>浏览器进程根据 DrawQuad 消息⽣成⻚⾯， 并显⽰到显⽰器上。</li></ol> <h3 id="浏览器对事件的处理"><a href="#浏览器对事件的处理" class="header-anchor">#</a> 浏览器对事件的处理</h3> <p>当页面渲染完毕以后，TAB内已经显示出了可交互的WEB页面，用户可以进行移动鼠标、点击页面等操作了，而当这些事件发生时候，浏览器是如何处理这些事件的呢？</p> <p>以点击事件（click event）为例，让鼠标点击页面时候，首先接受到事件信息的是<code>Browser Process</code>，但是Browser Process只知道事件发生的类型和发生的位置，具体怎么对这个点击事件进行处理，还是由Tab内的<code>Renderer Process</code>进行的。Browser Process接受到事件后，随后便把事件的信息传递给了渲染进程，渲染进程会找到根据事件发生的坐标，找到目标对象（target），并且运行这个目标对象的点击事件绑定的监听函数（listener）。</p> <h3 id="渲染进程中合成器线程接收事件"><a href="#渲染进程中合成器线程接收事件" class="header-anchor">#</a> 渲染进程中合成器线程接收事件</h3> <p>前面我们说到，合成器线程可以独立于主线程之外通过已光栅化的层创建组合帧，例如页面滚动，如果没有对页面滚动绑定相关的事件，组合器线程可以独立于主线程创建组合帧，如果页面绑定了页面滚动事件，合成器线程会等待主线程进行事件处理后才会创建组合帧。那么，合成器线程是如何判断出这个事件是否需要路由给主线程处理的呢？</p> <p>由于执行 JS 是主线程的工作，当页面合成时，合成器线程会标记页面中绑定有事件处理器的区域为<code>非快速滚动区域</code>(non-fast scrollable region)，如果事件发生在这些存在标注的区域，合成器线程会把事件信息发送给主线程，等待主线程进行事件处理，如果事件不是发生在这些区域，合成器线程则会直接合成新的帧而不用等到主线程的响应。</p> <p><img src="/learn-blog/dist/assets/img/bro1.c893e7e4.png" alt="非快速滚动区域有用户事件发生"></p> <h3 id="浏览器对事件的优化"><a href="#浏览器对事件的优化" class="header-anchor">#</a> 浏览器对事件的优化</h3> <p>一般我们屏幕的帧率是每秒60帧，也就是60fps，但是某些事件触发的频率超过了这个数值，比如wheel，mousewheel，mousemove，pointermove，touchmove，这些连续性的事件一般每秒会触发60~120次，假如每一次触发事件都将事件发送到主线程处理，由于屏幕的刷新速率相对来说较低，这样使得主线程会触发过量的命中测试以及JS代码，使得性能有了没必要是损耗。</p> <p><img src="/learn-blog/dist/assets/img/bro2.1def7a99.png" alt="事件淹没了屏幕刷新的时间轴，导致页面很卡顿"></p> <p>出于优化的目的，浏览器会合并这些连续的事件，延迟到下一帧渲染是执行，也就是<code>requestAnimationFrame</code>之前。</p> <p><img src="/learn-blog/dist/assets/img/bro3.dc8b24ef.png" alt="和之前相同的事件轴，可是这次事件被合并并延迟调度了"></p> <p>而对于非连续性的事件，如keydown，keyup，mousedown，mouseup，touchstart，touchend等，会直接派发给主线程去执行。</p> <h3 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h3> <p>https://zhuanlan.zhihu.com/p/74792085</p> <p><a href="https://segmentfault.com/a/1190000022633988" target="_blank" rel="noopener noreferrer">前端都该懂的浏览器工作原理，你懂了吗？ - SegmentFault 思否<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://blog.csdn.net/ithzhang/article/details/7917754" target="_blank" rel="noopener noreferrer">为什么浏览器会使用多进程架构<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.im/post/5e182a47e51d453cee48c752" target="_blank" rel="noopener noreferrer">一文看懂Chrome浏览器工作原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://zhuanlan.zhihu.com/p/102128787" target="_blank" rel="noopener noreferrer">浏览器多进程架构<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://zhuanlan.zhihu.com/p/47407398" target="_blank" rel="noopener noreferrer">图解浏览器的基本工作原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part2" target="_blank" rel="noopener noreferrer">Inside look at modern web browser (part 2)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developers.google.com/web/updates/2018/09/inside-browser-part3" target="_blank" rel="noopener noreferrer">Inside look at modern web browser (part 3)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">5/19/2021, 9:59:13 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learn-blog/dist/note/javascript/垃圾回收机制.html" class="prev">
        垃圾回收机制
      </a></span> <span class="next"><a href="/learn-blog/dist/note/HTTP/DNS.html">
        DNS
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><section class="side-anchor"><ul style="display:none;"></ul></section></div></div>
    <script src="/learn-blog/dist/assets/js/app.47b52d01.js" defer></script><script src="/learn-blog/dist/assets/js/2.9615dc11.js" defer></script><script src="/learn-blog/dist/assets/js/3.74cb7266.js" defer></script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service Worker | BINGO BLOG</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/learn-blog/dist/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css">
    <meta name="description" content="BINGO BLOG 学然后知不足 非淡泊无以明志，非宁静无以致远">
    <meta name="keywords" content="博客，前端，代码，个人博客，学习，兴趣，BINGOBLOG">
    
    <link rel="preload" href="/learn-blog/dist/assets/css/0.styles.4b1e8fc9.css" as="style"><link rel="preload" href="/learn-blog/dist/assets/js/app.47b52d01.js" as="script"><link rel="preload" href="/learn-blog/dist/assets/js/2.9615dc11.js" as="script"><link rel="preload" href="/learn-blog/dist/assets/js/79.b6ab4d41.js" as="script"><link rel="prefetch" href="/learn-blog/dist/assets/js/10.fee66f5e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/11.bb11362d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/12.091ef70a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/13.1322aae2.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/14.0cba4e5e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/15.793bd97a.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/16.3a5f59bb.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/17.2da1d357.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/18.0e13a599.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/19.9d2bd949.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/20.1897b020.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/21.cedcbaa2.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/22.d944ca7e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/23.52428397.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/24.856765a8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/25.c6df9714.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/26.4e7b62da.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/27.f32b3f6b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/28.3ef7e612.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/29.22113ff4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/3.74cb7266.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/30.4045b06f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/31.8d00d40c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/32.6f89db35.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/33.9282d757.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/34.f3174724.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/35.3463c572.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/36.e0f19ebe.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/37.d6bc54a8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/38.6005ad2e.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/39.61965404.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/4.5da2aed6.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/40.c693a727.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/41.36030a88.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/42.8e62f3cc.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/43.8cf4416b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/44.a7c2a2f3.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/45.010cdc4c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/46.f6dd44ce.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/47.592d1c79.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/48.77790547.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/49.930654fd.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/5.f2f4abf5.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/50.00cbb1a7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/51.b146a658.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/52.471a97b4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/53.c96393b4.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/54.44209354.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/55.8578b003.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/56.773a7161.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/57.f4b76cad.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/58.7f183d5b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/59.55f64c91.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/6.8b279cc8.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/60.ac86f15d.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/61.20bf2208.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/62.ba039020.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/63.4b48631b.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/64.05fd7730.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/65.cba67421.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/66.c52d59cb.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/67.49090420.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/68.c8c77d51.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/69.cfc23bfa.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/7.da7d15f7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/70.de51e2ce.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/71.ee88707f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/72.21197ef7.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/73.556deedb.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/74.f5381499.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/75.ff8fbe7f.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/76.2d4e5564.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/77.165a2061.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/78.96ba1617.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/8.960eb72c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/80.49f7142c.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/81.91f76553.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/82.59382fa9.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/83.6d327eaa.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/84.36b7afe9.js"><link rel="prefetch" href="/learn-blog/dist/assets/js/9.1b4e1c73.js">
    <link rel="stylesheet" href="/learn-blog/dist/assets/css/0.styles.4b1e8fc9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-blog/dist/" class="home-link router-link-active"><img src="/learn-blog/dist/logo.png" alt="BINGO BLOG" class="logo"> <span class="site-name can-hide">BINGO BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/learn-blog/dist/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/learn-blog/dist/algorithm/" class="nav-link">
  算法
</a></div> <a href="https://github.com/bingoYB/learn-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/learn-blog/dist/note/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/learn-blog/dist/algorithm/" class="nav-link">
  算法
</a></div> <a href="https://github.com/bingoYB/learn-blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程思想</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JavaScript</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-blog/dist/note/javascript/JS执行上下文.html" class="sidebar-link">JS执行上下文</a></li><li><a href="/learn-blog/dist/note/javascript/WebWorker.html" class="sidebar-link">Web Worker</a></li><li><a href="/learn-blog/dist/note/javascript/Workbox.html" class="sidebar-link">PWA之Workbox缓存策略分析</a></li><li><a href="/learn-blog/dist/note/javascript/serviceworker.html" aria-current="page" class="active sidebar-link">Service Worker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#概念" class="sidebar-link">概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#特点" class="sidebar-link">特点</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#pwa" class="sidebar-link">PWA</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#生命周期" class="sidebar-link">生命周期</a></li></ul></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#使用之前" class="sidebar-link">使用之前</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#使用" class="sidebar-link">使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#注册" class="sidebar-link">注册</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#service-worker-的更新" class="sidebar-link">Service Worker 的更新</a></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#service-worker-事件处理" class="sidebar-link">Service Worker 事件处理</a></li></ul></li><li class="sidebar-sub-header"><a href="/learn-blog/dist/note/javascript/serviceworker.html#其他相关参考" class="sidebar-link">其他相关参考</a></li></ul></li><li><a href="/learn-blog/dist/note/javascript/垃圾回收技术.html" class="sidebar-link">垃圾回收技术</a></li><li><a href="/learn-blog/dist/note/javascript/垃圾回收机制.html" class="sidebar-link">垃圾回收机制</a></li><li><a href="/learn-blog/dist/note/javascript/浏览器渲染机制.html" class="sidebar-link">浏览器工作原理</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>HTTP</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Node</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>webpack</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端图形学</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端工程化</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="service-worker"><a href="#service-worker" class="header-anchor">#</a> Service Worker</h1> <p>Service workers 本质上充当 Web 应用程序、浏览器与网络（可用时）之间的代理服务器。这个 API 旨在创建有效的离线体验，它会拦截网络请求并根据网络是否可用采取来适当的动作、更新来自服务器的的资源。它还提供入口以推送通知和访问后台同步 API。</p> <h2 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h2> <p>Service worker是一个注册在指定源和路径下的事件驱动<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Worker" target="_blank" rel="noopener noreferrer">worker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。它采用JavaScript控制关联的页面或者网站，拦截并修改访问和资源请求，细粒度地缓存资源。你可以完全控制应用在特定情形（最常见的情形是网络不可用）下的表现。</p> <p>Service worker运行在worker上下文，因此它不能访问DOM。相对于驱动应用的主JavaScript线程，它运行在其他线程中，所以不会造成阻塞。它设计为完全异步，同步API（如<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="noopener noreferrer">XHR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>和<a href="https://developer.mozilla.org/zh-CN/docs/conflicting/Web/API/Web_Storage_API" target="_blank" rel="noopener noreferrer">localStorage<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）不能在service worker中使用。</p> <p>基于 Service Worker API 的特性，结合 Fetch API、Cache API、Push API、postMessage API 和 Notification API，可以在基于浏览器的 web 应用中实现如离线缓存、消息推送、静默更新等 native 应用常见的功能，以给 web 应用提供更好更丰富的使用体验。</p> <h3 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h3> <ul><li>网站必须使用 HTTPS。除了使用本地开发环境调试时(如域名使用 <code>localhost</code>)</li> <li>运行于浏览器后台，可以控制打开的作用域范围下所有的页面请求</li> <li>单独的作用域范围，单独的运行环境和执行线程</li> <li>不能操作页面 DOM。但可以通过事件机制来处理</li></ul> <h3 id="pwa"><a href="#pwa" class="header-anchor">#</a> PWA</h3> <p>谷歌给以 Service Worker API 为核心实现的 web 应用取了个高大上的名字：<code>Progressive Web Apps</code>（PWA，渐进式增强 WEB 应用），并且在其主要产品上进行了深入的实践。那么，符合 PWA 的应用特点是什么？以下为来自谷歌工程师的解答。</p> <p>Progressive Web Apps 是:</p> <ul><li><strong>渐进增强</strong> – 能够让每一位用户使用，无论用户使用什么浏览器，因为它是始终以渐进增强为原则。</li> <li><strong>响应式用户界面</strong> – 适应任何环境：桌面电脑，智能手机，笔记本电脑，或者其他设备。</li> <li><strong>不依赖网络连接</strong> – 通过 Service Workers 可以在离线或者网速极差的环境下工作。</li> <li><strong>类原生应用</strong> – 有像原生应用般的交互和导航给用户原生应用般的体验，因为它是建立在 app shell model 上的。</li> <li><strong>持续更新</strong> – 受益于 Service Worker 的更新进程，应用能够始终保持更新。</li> <li><strong>安全</strong> – 通过 HTTPS 来提供服务来防止网络窥探，保证内容不被篡改。</li> <li><strong>可发现</strong> – 得益于 W3C manifests 元数据和 Service Worker 的登记，让搜索引擎能够找到 web 应用。</li> <li><strong>再次访问</strong> – 通过消息推送等特性让用户再次访问变得容易。</li> <li><strong>可安装</strong> – 允许用户保留对他们有用的应用在主屏幕上，不需要通过应用商店。</li> <li><strong>可连接性</strong> – 通过 URL 可以轻松分享应用，不用复杂的安装即可运行。</li></ul> <h3 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>install -&gt; installed -&gt; actvating -&gt; Active -&gt; Activated -&gt; Redundant
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="使用之前"><a href="#使用之前" class="header-anchor">#</a> 使用之前</h2> <p>1、使用 <code>HTTPS</code> 访问，并且 SSL 证书要正确。关于 https 和 SSL 证书的内容</p> <p>2、基础API了解</p> <ul><li><p>Fetch API: https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API</p> <p>Fetch API 用于 HTTP 请求处理，可以替代 <code>XMLHttpRequest</code> 实现异步请求(ajax)，但功能上更为完善。</p></li> <li><p>Cache API: https://developer.mozilla.org/zh-CN/docs/Web/API/Cache</p> <p>Cache API 用于对 HTTP 请求进行缓存管理，是在 ServiceWorker 的规范中定义的，一般也跟 ServiceWorker 一起使用，是实现离线应用的关键。但是 Cache API 又不依赖于 Service Worker，可以单独使用。</p></li></ul> <h2 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h2> <h3 id="注册"><a href="#注册" class="header-anchor">#</a> 注册</h3> <p>在网站页面上注册实现 Service Worker 功能逻辑的脚本。例如注册 <code>/sw/sw.js</code> 文件，参考代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span>serviceWorker
    <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/sw/sw.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>scope<span class="token operator">:</span> <span class="token string">'/'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker 注册成功！作用域为: '</span><span class="token punctuation">,</span> registration<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker 注册失败: '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>chrome 浏览器下，注册成功后，可以打开 <code>chrome://serviceworker-internals/</code> 查看浏览器的 Service Worker 信息。</p> <p><strong>注意：</strong></p> <p>Service Worker 的注册路径决定了其 <code>scope</code> 默认作用范围。示例中 <code>sw.js</code> 是在 <code>/sw/</code> 路径下，这使得该 Service Worker 默认只会收到 <code>/sw/</code> 路径下的 fetch 事件。如果存放在网站的根路径下，则将会收到该网站的所有 fetch 事件。
如果希望改变它的作用域，可在第二个参数设置 scope 范围。示例中将其改为了根目录，即对整个站点生效。</p> <p>另外应意识到这一点：Service Worker 没有页面作用域的概念，作用域范围内的所有页面请求都会被当前激活的 Service Worker 所监控。</p> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <p>前一步在页面中仅注册了 <code>sw.js</code> 脚本，具体的逻辑行为则在 <code>sw.js</code> 内实现。那么这里面要做什么呢？参考示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 用于标注创建的缓存，也可以根据它来建立版本规范</span>
<span class="token keyword">const</span> <span class="token constant">CACHE_NAME</span> <span class="token operator">=</span> <span class="token string">&quot;lzwme_cache_v1.0.0&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 列举要默认缓存的静态资源，一般用于离线使用</span>
<span class="token keyword">const</span> urlsToCache <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token string">'/offline.html'</span><span class="token punctuation">,</span>
  <span class="token string">'/offline.png'</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// self 为当前 scope 内的上下文</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// event.waitUtil 用于在安装成功之前执行一些预装逻辑</span>
  <span class="token comment">// 但是建议只做一些轻量级和非常重要资源的缓存，减少安装失败的概率</span>
  <span class="token comment">// 安装成功后 ServiceWorker 状态会从 installing 变为 installed</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
    <span class="token comment">// 使用 cache API 打开指定的 cache 文件</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cache</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 添加要缓存的资源列表</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>urlsToCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>需要注意的是，只有 <code>urlsToCache</code> 中的文件全部安装成功，Service Worker 才会认为安装完成。否则会认为安装失败，安装失败则进入 <code>redundant</code> (废弃)状态。所以这里应当尽量少地缓存资源(一般为离线时需要但联网时不会访问到的内容)，以提升成功率。</p> <p>安装成功后，即进入等待(waiting)或激活(active)状态。在激活状态可通过监听各种事件，实现更为复杂的逻辑需求。具体参见后文<code>事件处理</code>部分。</p> <h3 id="service-worker-的更新"><a href="#service-worker-的更新" class="header-anchor">#</a> Service Worker 的更新</h3> <p>如果 <code>sw.js</code> 文件的内容有改动，当访问网站页面时浏览器获取了新的文件，它会认为有更新，于是会安装新的文件并触发 <code>install</code> 事件。但是此时已经处于激活状态的旧的 Service Worker 还在运行，新的 Service Worker 完成安装后会进入 waiting 状态。直到所有已打开的页面都关闭，旧的 Service Worker 自动停止，新的 Service Worker 才会在接下来打开的页面里生效。</p> <p>如果希望在有了新版本时，所有的页面都得到及时更新怎么办呢？</p> <p>可以在 <code>install</code> 事件中执行 <code>skipWaiting</code> 方法跳过 waiting 状态，然后会直接进入 <code>activate</code> 阶段。接着在 <code>activate</code> 事件发生时，通过执行 <code>clients.claim</code> 方法，更新所有客户端上的 Service Worker。示例</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 安装阶段跳过等待，直接进入 active</span>
self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">skipWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span>
  Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token comment">// 更新客户端</span>
    clients<span class="token punctuation">.</span><span class="token function">claim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 清理旧版本</span>
    caches<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cacheList</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      cacheList<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">cacheName</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>cacheName <span class="token operator">!==</span> <span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          caches<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>cacheName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>手动更新</strong></p> <p>其实在页面中，也可以手动来管理更新。参考如下示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> version <span class="token operator">=</span> <span class="token string">'1.0.1'</span><span class="token punctuation">;</span>

navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/sw.js'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">reg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'sw_version'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> version<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    reg<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'sw_version'</span><span class="token punctuation">,</span> version<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="service-worker-事件处理"><a href="#service-worker-事件处理" class="header-anchor">#</a> Service Worker 事件处理</h3> <p>在安装过程中我们实现了资源缓存，安装完成后则进入了空闲阶段，此时可以通过监听各种事件实现各种逻辑。下面对常见的相关事件作简要介绍。</p> <h4 id="install-事件"><a href="#install-事件" class="header-anchor">#</a> install 事件</h4> <p>当前脚本被安装时，会触发 <code>install</code> 事件，具体参考前文的 <code>安装</code> 部分的示例。</p> <h4 id="fetch-事件"><a href="#fetch-事件" class="header-anchor">#</a> fetch 事件</h4> <p>当浏览器发起请求时，会触发 <code>fetch</code> 事件。</p> <p>Service Worker 安装成功并进入激活状态后即运行于浏览器后台，可以通过 <code>fetch</code> 事件可以拦截到当前作用域范围内的 http/https 请求，并且给出自己的响应。结合 <code>Fetch API</code> ，可以简单方便地处理请求响应，实现对网络请求的控制。</p> <p>这个功能是十分强大的。</p> <p>参考下面的示例，这里实现了一个<code>缓存优先、降级处理</code>的策略逻辑：监控所有 http 请求，当请求资源已经在缓存里了，直接返回缓存里的内容；否则使用 <code>fetch API</code> 继续请求，如果是 图片或 css、js 资源，请求成功后将他们加入缓存中；如果是离线状态或请求出错，则降级返回预缓存的离线内容。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 联网状态下执行</span>
<span class="token keyword">function</span> <span class="token function">onlineRequest</span><span class="token punctuation">(</span><span class="token parameter">fetchRequest</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用 fecth API 获取资源，以实现对资源请求控制</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在资源请求成功后，将 image、js、css 资源加入缓存列表</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span>response
      <span class="token operator">||</span> response<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">200</span>
      <span class="token operator">||</span> <span class="token operator">!</span>response<span class="token punctuation">.</span>headers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">image|javascript|test\/css</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> response<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> responseToCache <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    caches<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token constant">CACHE_NAME</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cache</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">,</span> responseToCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> response<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取失败，离线资源降级替换</span>
    <span class="token function">offlineRequest</span><span class="token punctuation">(</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 离线状态下执行，降级替换</span>
<span class="token keyword">function</span> <span class="token function">offlineRequest</span><span class="token punctuation">(</span><span class="token parameter">request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用离线图片</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|gif|jpg)</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'/images/offline.png'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 使用离线页面</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.html$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token string">'/test/offline.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'fetch'</span><span class="token punctuation">,</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">respondWith</span><span class="token punctuation">(</span>
    caches<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">hit</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 返回缓存中命中的文件</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> hit<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> fetchRequest <span class="token operator">=</span> event<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>navigator<span class="token punctuation">.</span>online<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果为联网状态</span>
          <span class="token keyword">return</span> <span class="token function">onlineRequest</span><span class="token punctuation">(</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 如果为离线状态</span>
          <span class="token keyword">return</span> <span class="token function">offlineRequest</span><span class="token punctuation">(</span>fetchRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><h4 id="activate-事件"><a href="#activate-事件" class="header-anchor">#</a> activate 事件</h4> <p>当安装完成后并进入激活状态，会触发 <code>activate</code> 事件。通过监听 <code>activate</code> 事件你可以做一些预处理，如对于旧版本的更新、对于无用缓存的清理等。</p> <p>在下面的示例中，我们实现对旧版本的缓存资源清理：</p> <p>传给 <code>waitUntil()</code> 的 Promise 会阻塞其他的事件，直到它完成。这可以确保清理操作会在第一次 fetch 事件之前完成。
在激活时也可执行 <code>clients.claim</code> 方法，更新所有客户端上的 Service Worker。</p> <h4 id="push-事件"><a href="#push-事件" class="header-anchor">#</a> push 事件</h4> <p>push 事件是为推送准备的。不过首先你需要了解一下 <code>Notification API</code> 和 <code>PUSH API</code>(相关链接见后文)。</p> <p>通过 PUSH API，当订阅了推送服务后，可以使用推送方式唤醒 ServiceWorker 以响应来自系统消息传递服务的消息，即使用户已经关闭了页面。</p> <p>推送的实现有两步：</p> <p>不同浏览器需要用不同的推送消息服务器。以 Chrome 上使用 Google Cloud Messaging<GCM> 作为推送服务为例，第一步是注册 applicationServerKey(通过 GCM 注册获取)，并在页面上进行订阅或发起订阅。每一个会话会有一个独立的端点（endpoint），订阅对象的属性(PushSubscription.endpoint) 即为端点值。将端点发送给服务器后，服务器用这一值来发送消息给会话的激活的 Service Worker （通过 GCM 与浏览器客户端沟通）。</GCM></p> <p>在页面上，使用 <code>PushManager.subscribe()</code> 来订阅推送服务。示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 向用户申请通知权限，用户可以选择允许或禁止</span>
<span class="token comment">// Notification.requestPermission 只有在页面上才可执行，Service Worker 内部不可申请权限</span>
Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">grant</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>grant<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果获得权限，会得到 granted</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">'denied'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用户拒绝了通知权限</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Permission for Notifications was denied'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> reg<span class="token punctuation">;</span>
<span class="token keyword">const</span> applicationServerKey <span class="token operator">=</span> <span class="token string">'xxx'</span><span class="token punctuation">;</span> <span class="token comment">// 应用服务器的公钥（base64 网址安全编码）</span>
navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">_reg</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  reg <span class="token operator">=</span> _reg<span class="token punctuation">;</span>
  <span class="token comment">// 获取当前订阅的推送</span>
  <span class="token keyword">return</span> reg<span class="token punctuation">.</span>pushManager<span class="token punctuation">.</span><span class="token function">getSubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">subscription</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取的结果没有任何订阅，发起一个订阅</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> reg<span class="token punctuation">.</span>pushManager<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        userVisibleOnly<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        applicationServerKey<span class="token operator">:</span> applicationServerKey
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 每一个会话会有一个独立的端点(endpoint)，用于推送时后端识别</span>
      <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;已订阅 endpoint:&quot;</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">subscription</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>subscription<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 订阅成功</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'订阅成功！'</span><span class="token punctuation">,</span> subscription<span class="token punctuation">.</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 做更多的事情，如将订阅信息发送给后端，用于后端推送识别</span>
    <span class="token comment">// const key = subscription.getKey('p256dh');</span>
    <span class="token comment">// updateStatus(subscription.endpoint, key, 'subscribe');</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 订阅失败</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Unable to subscribe to push.'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>第二步比较简单，是在 Service Worker 中通过监听 <code>push</code> 事件对推送的消息作处理。示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 读取 event.data 获取传递过来的数据，根据该数据做进一步的逻辑处理</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> event<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 逻辑处理示例</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Notification<span class="token punctuation">.</span>permission <span class="token operator">===</span> <span class="token string">'granted'</span> <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>action <span class="token operator">===</span> <span class="token string">'subscribe'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span><span class="token string">&quot;Hi：&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      body<span class="token operator">:</span> <span class="token string">'订阅成功 ~'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'//lzw.me/images/avatar/lzwme-80x80.png'</span><span class="token punctuation">,</span>
      tag<span class="token operator">:</span> <span class="token string">'push'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这里有一个关于推送(PUSH API)的完整示例可作参考：</p> <p>https://github.com/chrisdavidmills/push-api-demo</p> <h4 id="sync-事件"><a href="#sync-事件" class="header-anchor">#</a> sync 事件</h4> <p>sync 事件由 <code>background sync</code> (后台同步)发出。background sync 是 Google 配合 SW 推出的 API，用于为 SW 提供一个可以实现注册和监听同步处理的方法。但它还不在 W3C WEB API 标准中。在 Chrome 中这也只是一个实验性功能，需要访问 <code>chrome://flags/#enable-experimental-web-platform-features</code> ，开启该功能，然后重启生效。</p> <p>后台同步功能允许你一次性或按间隔请求后台数据同步，即使用户没有打开网站，仅唤醒了 ServiceWorker，也会如此。</p> <p>当你从页面请求执行此操作的权限，用户将收到提示。后台同步适合于： 非紧急更新，特别是那些需要定期进行的更新，每次更新都发送一个推送通知会显得太频繁，如在某个时间推送一篇特色文章或一条消息通知，这在 native 应用中非常常见。</p> <p>参考下面的示例。</p> <p>A. 在页面注册 sync：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">swRegistration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> swRegistration<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'myFirstSync'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>B. 在 SW 中监听 <code>sync</code> 事件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'sync'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'myFirstSync'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="message-事件"><a href="#message-事件" class="header-anchor">#</a> message 事件</h4> <p>ServiceWorker 运行于独立的沙盒中，无法直接访问当前页面的 DOM 等信息，但是通过 <code>postMessage</code> API，可以实现他们之间的消息传递。</p> <p>跨文档的 postMessage 消息传输，需要获取接收方的文档句柄。那么当需要将消息从页面传输给 ServiceWorker 或从 ServiceWorker 传输给页面时，如何获取对应的文档句柄？我们参考下面的示例来了解。</p> <p>A. 页面发消息给 serviceWorker</p> <p>在页面上通过 <code>navigator.serviceWorker.controller</code> 获得 ServiceWorker 的句柄。但只有 ServiceWorker 注册成功后该句柄才会存在。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> controller <span class="token operator">=</span> navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>controller<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>controller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  controller<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在 serviceWorker 注册成功后，页面上即可通过 navigator.serviceWorker.controller 发送消息给它</span>
navigator<span class="token punctuation">.</span>serviceWorker
  <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/test/sw.js'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> scope<span class="token operator">:</span> <span class="token string">'/test/'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">registration</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker 注册成功！作用域为: '</span><span class="token punctuation">,</span> registration<span class="token punctuation">.</span>scope<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">sendMsg</span><span class="token punctuation">(</span><span class="token string">'hello sw!'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'ServiceWorker 注册失败: '</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在 ServiceWorker 内部，可以通过监听 message 事件即可获得消息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ev</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>B：ServiceWorker 发消息给页面</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span>clients<span class="token punctuation">.</span><span class="token function">matchAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">clientList</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    clientList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">client</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">'Hi, I am send from Service worker！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="online-offline-事件"><a href="#online-offline-事件" class="header-anchor">#</a> online/offline 事件</h4> <p>当网络状态发生变化时，会触发 <code>online</code> 或 <code>offline</code> 事件。结合这两个事件，可以与 <code>Service Worker</code> 结合实现更好的离线使用体验，例如当网络发生改变时，替换/隐藏需要在线状态才能使用的链接导航等。</p> <p>下面是一个监听 <code>offline</code> 的示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'offline'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">grant</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>grant <span class="token operator">!==</span> <span class="token string">'granted'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token string">&quot;Hi，网络不给力哟&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      body<span class="token operator">:</span> <span class="token string">'您的网络貌似离线了，不过在志文工作室里访问过的页面还可以继续打开~'</span><span class="token punctuation">,</span>
      icon<span class="token operator">:</span> <span class="token string">'//lzw.me/images/avatar/lzwme-80x80.png'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    notification<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notification<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h4 id="error-和-unhandledrejection-事件"><a href="#error-和-unhandledrejection-事件" class="header-anchor">#</a> error 和 unhandledrejection 事件</h4> <p>当 JS 执行发生错误，会触发 error 事件；当 Promise 类型的回调发生 reject 却没有 catch 处理，会触发 unhandledrejection 事件。</p> <p>对于这类事件，前端应当作埋点上报，以便于统计监控和及时发现处理。一般情况下上报的信息应从 error 中读取，主要包括错误堆栈相关信息以便定位。参考如下示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">errorMessage<span class="token punctuation">,</span> scriptURI<span class="token punctuation">,</span> lineNumber<span class="token punctuation">,</span> columnNumber<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">reportError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            message<span class="token operator">:</span> errorMessage<span class="token punctuation">,</span>
            script<span class="token operator">:</span> scriptURI<span class="token punctuation">,</span>
            line<span class="token operator">:</span> lineNumber，
            column<span class="token operator">:</span> columnNumber
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>监听 <code>unhandledrejection</code> 事件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'unhandledrejection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">reportError</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    message<span class="token operator">:</span> event<span class="token punctuation">.</span>reason
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="beforeinstallprompt-事件"><a href="#beforeinstallprompt-事件" class="header-anchor">#</a> beforeinstallprompt 事件</h4> <p>当发生 <code>Add to Homescreen</code> (A2HS, 添加到主屏幕)行为的请求时，会触发该事件。它发生于页面中，与 Service Worker 并没有直接关系。</p> <p>如果你的站点符合 A2HS 的条件(具体参见后文介绍)，浏览器(chrome) 会根据默认的行为算法，来决定何时主动的向用户展示添加到首屏提示。另外，用户也可以通过 chrome 菜单中的 <code>添加到主屏幕</code> 选项主动添加。</p> <p>可以在页面中通过监听 <code>beforeinstallprompt</code> 事件，决定是否屏蔽/延迟该行为，或者统计用户选择了允许还是拒绝。示例：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> deferredPrompt<span class="token punctuation">;</span> <span class="token comment">// 用于缓存 beforeinstallprompt 的事件对象</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'beforeinstallprompt'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 阻止该行为，只需要返回 false</span>
  <span class="token comment">// event.preventDefault();</span>
  <span class="token comment">// deferredPrompt = event;</span>
  <span class="token comment">// return false;</span>

  <span class="token comment">// 统计用户的选择</span>
  event<span class="token punctuation">.</span>userChoice<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">choiceResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>choiceResult<span class="token punctuation">.</span>outcome<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 为 dismissed 或 accepted</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>choiceResult<span class="token punctuation">.</span>outcome <span class="token operator">===</span> <span class="token string">'dismissed'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User cancelled home screen install'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User added to home screen'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 在 beforeinstallprompt 事件中屏蔽了浏览器的默认行为，在页面中通过按钮让用户主动选择</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'addToHomeScreen'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deferredPrompt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    deferredPrompt<span class="token punctuation">.</span><span class="token function">prompt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h2 id="其他相关参考"><a href="#其他相关参考" class="header-anchor">#</a> 其他相关参考</h2> <ul><li><p>[网站渐进式增强体验(PWA)改造：Service Worker 应用详解 - 志文工作室 (lzw.me)](https://lzw.me/a/pwa-service-worker.html#1 什么是 Service Worker)</p></li> <li><p>https://w3c.github.io/ServiceWorker/</p></li> <li><p>https://www.w3.org/TR/service-workers/</p></li> <li><p>https://github.com/w3c/ServiceWorker</p></li> <li><p>Using Service Workers https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers</p></li> <li><p>Service_Worker_API https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API</p></li> <li><p>Progressive Web Apps https://developers.google.com/web/progressive-web-apps/</p></li> <li><p>https://developers.google.com/web/fundamentals/getting-started/primers/service-workers</p></li> <li><p>https://developers.google.com/web/fundamentals/getting-started/codelabs/your-first-pwapp/?hl=zh-cn</p></li> <li><p>SW 离线指南 https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/</p></li> <li><p>Service Workers’ API 信息图 https://github.com/delapuente/service-workers-101</p></li> <li><p>Service Workers 与离线缓存 https://segmentfault.com/a/1190000008491458</p></li> <li><p>【Service Worker】生命周期那些事儿 https://segmentfault.com/a/1190000007487049</p></li> <li><p>Service Worker 生命周期 https://segmentfault.com/a/1190000006061528</p></li> <li><p>https://www.pangjian.me/2017/02/08/service-worker-offlinemode/</p></li> <li><p>https://www.slideshare.net/patrickmeenan/service-workers-for-performance</p></li> <li><p>PWA 在饿了么的实践经验 https://zhuanlan.zhihu.com/p/25800461</p></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">5/19/2021, 9:59:13 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/learn-blog/dist/note/javascript/Workbox.html" class="prev">
        PWA之Workbox缓存策略分析
      </a></span> <span class="next"><a href="/learn-blog/dist/note/javascript/垃圾回收技术.html">
        垃圾回收技术
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><section class="side-anchor"><ul style="display:none;"></ul></section></div></div>
    <script src="/learn-blog/dist/assets/js/app.47b52d01.js" defer></script><script src="/learn-blog/dist/assets/js/2.9615dc11.js" defer></script><script src="/learn-blog/dist/assets/js/79.b6ab4d41.js" defer></script>
  </body>
</html>
